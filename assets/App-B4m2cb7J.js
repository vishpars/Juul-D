import{c as H,r,s as L,j as e,M as Te,n as Ne,b as pe,f as Z,X as ke,d as je,T as rt,o as ot,e as lt,p as nt}from"./index-C8M5upcy.js";import{B as le,P as ne,M as K,F as Re,E as Fe,a as it,L as ct,C as dt}from"./Modal-D0sCTuFc.js";import{T as _e,P as be,C as ue,a as De,S as xt,b as pt}from"./trash-2-BAxENHxM.js";import{S as ut,a as ht}from"./square-CsFyjm7m.js";/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],bt=H("arrow-left",mt);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}]],Qe=H("book",ft);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Ue=H("circle-check-big",gt);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=[["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}],["path",{d:"M9 14 4 9l5-5",key:"102s5s"}]],jt=H("corner-up-left",vt);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=[["path",{d:"M2 9V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-1",key:"fm4g5t"}],["path",{d:"M2 13h10",key:"pgb2dq"}],["path",{d:"m9 16 3-3-3-3",key:"6m91ic"}]],yt=H("folder-input",wt);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]],ie=H("folder-open",Nt);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=[["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],xe=H("folder",kt);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=[["path",{d:"M10.5 3 8 9l4 13 4-13-2.5-6",key:"b3dvk1"}],["path",{d:"M17 3a2 2 0 0 1 1.6.8l3 4a2 2 0 0 1 .013 2.382l-7.99 10.986a2 2 0 0 1-3.247 0l-7.99-10.986A2 2 0 0 1 2.4 7.8l2.998-3.997A2 2 0 0 1 7 3z",key:"7w4byz"}],["path",{d:"M2 9h20",key:"16fsjt"}]],He=H("gem",_t);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"r6nss1"}]],we=H("house",Ct);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const St=[["line",{x1:"2",x2:"5",y1:"12",y2:"12",key:"bvdh0s"}],["line",{x1:"19",x2:"22",y1:"12",y2:"12",key:"1tbv5k"}],["line",{x1:"12",x2:"12",y1:"2",y2:"5",key:"11lu5j"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}],["circle",{cx:"12",cy:"12",r:"7",key:"fim9np"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],$e=H("locate-fixed",St);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zt=[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]],Ce=H("map-pin",zt);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],Se=H("map",Mt);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],$t=H("pencil",Et);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=[["path",{d:"M19 17V5a2 2 0 0 0-2-2H4",key:"zz82l3"}],["path",{d:"M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v1a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v2a1 1 0 0 0 1 1h3",key:"1ph1d7"}]],Ot=H("scroll",Lt);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=[["path",{d:"M16 10a4 4 0 0 1-8 0",key:"1ltviw"}],["path",{d:"M3.103 6.034h17.794",key:"awc11p"}],["path",{d:"M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z",key:"o988cm"}]],It=H("shopping-bag",Pt),Bt=()=>{const[t,a]=r.useState([]),[c,p]=r.useState(!0),[f,x]=r.useState(null),w=r.useRef(!1),g=r.useCallback(async()=>{p(!0),x(null);try{const{data:s,error:i}=await L.from("library").select("*");if(i)throw i;a(s||[])}catch(s){console.error("Supabase fetch failed:",s),x(s.message||"Failed to load library"),a([])}finally{p(!1)}},[]);return r.useEffect(()=>{w.current||(w.current=!0,g())},[g]),{books:t,loading:c,error:f,addBook:async s=>{try{const{data:i,error:o}=await L.from("library").insert([s]).select().single();if(o)throw o;return i&&a(v=>[i,...v]),i}catch(i){throw console.error("Error adding book:",i),x("Failed to sync with server: "+i.message),i}},updateBook:async(s,i)=>{a(o=>o.map(v=>v.id===s?{...v,...i}:v));try{const{error:o}=await L.from("library").update(i).eq("id",s);if(o)throw o}catch(o){console.error("Error updating book:",o),x("Failed to update book"),g()}},deleteBook:async s=>{const i=[...t];a(o=>o.filter(v=>v.id!==s));try{const{error:o}=await L.from("library").delete().eq("id",s);if(o)throw o}catch(o){console.error("Error deleting book:",o),x("Failed to delete book"),a(i)}},refresh:g}},fe=(t="",a="")=>{const c=t.split(/[^0-9]+/).filter(x=>x!=="").map(Number),p=a.split(/[^0-9]+/).filter(x=>x!=="").map(Number),f=Math.max(c.length,p.length);for(let x=0;x<f;x++){const w=c[x]!==void 0?c[x]:-1,g=p[x]!==void 0?p[x]:-1;if(w!==g)return w-g}return 0},At=()=>{const[t,a]=r.useState([]),[c,p]=r.useState(!0),[f,x]=r.useState(null),w=r.useRef(!1),g=r.useCallback(async()=>{p(!0);try{const{data:s,error:i}=await L.from("library_categories").select("*");if(i)throw i;const o=(s||[]).sort((v,u)=>fe(v.code,u.code));a(o)}catch(s){console.error("Error fetching categories:",s),x(s.message)}finally{p(!1)}},[]);return r.useEffect(()=>{w.current||(w.current=!0,g())},[g]),{categories:t,loading:c,error:f,addCategory:async(s,i)=>{try{const o={name:s,parent_id:i},{data:v,error:u}=await L.from("library_categories").insert([o]).select();if(u)throw u;const h=v&&v.length>0?v[0]:null;return h?a(z=>[...z,h].sort(($,O)=>fe($.code,O.code))):await g(),h}catch(o){throw console.error("Error adding category:",o),x("Failed to add category: "+o.message),o}},updateCategory:async(s,i)=>{a(o=>o.map(u=>u.id===s?{...u,...i}:u).sort((u,h)=>fe(u.code,h.code)));try{const{error:o}=await L.from("library_categories").update(i).eq("id",s);if(o)throw o}catch(o){console.error("Error updating category:",o),x("Failed to update category: "+o.message),g()}},deleteCategory:async s=>{const i=[...t];a(o=>o.filter(v=>v.id!==s));try{const{error:o}=await L.from("library_categories").delete().eq("id",s);if(o)throw o}catch(o){console.error("Error deleting category:",o),x("Failed to delete category: "+o.message),a(i)}},refresh:g}},Tt=t=>e.jsx("input",{...t,className:`w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 placeholder-violet-900/40 focus:border-violet-500 focus:shadow-[0_0_15px_rgba(139,92,246,0.3)] outline-none transition-all duration-300 backdrop-blur-sm ${t.className}`}),ge=t=>e.jsx("textarea",{...t,className:`w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 placeholder-violet-900/40 focus:border-violet-500 focus:shadow-[0_0_15px_rgba(139,92,246,0.3)] outline-none transition-all duration-300 backdrop-blur-sm resize-none ${t.className}`}),Rt=({checked:t,onChange:a,label:c})=>e.jsxs("div",{onClick:()=>a(!t),className:"cursor-pointer flex items-center gap-3 select-none group",children:[e.jsxs("div",{className:`relative w-8 h-8 flex items-center justify-center transition-all duration-500 ${t?"scale-110":"scale-100 opacity-60"}`,children:[e.jsx("div",{className:`absolute inset-0 bg-violet-500 blur-md rounded-full transition-opacity duration-500 ${t?"opacity-40":"opacity-0"}`}),e.jsx(He,{size:24,className:`transition-all duration-500 ${t?"text-violet-300 fill-violet-900/80 drop-shadow-[0_0_8px_rgba(167,139,250,0.8)]":"text-slate-600"}`})]}),e.jsx("span",{className:`text-sm font-bold tracking-wide transition-colors ${t?"text-violet-200":"text-slate-500"}`,children:c})]}),Ft=t=>{const a=new Map,c=[];return t.forEach(p=>a.set(p.id,{...p,children:[]})),t.forEach(p=>{const f=a.get(p.id);f&&(p.parent_id&&a.has(p.parent_id)?a.get(p.parent_id).children.push(f):c.push(f))}),c},ye=(t,a)=>{if(a===null)return[];const c=t.find(p=>p.id===a);return c?c.parent_id?[...ye(t,c.parent_id),c]:[c]:[]},Ve=({nodes:t,onSelect:a,selectedId:c})=>e.jsx("div",{className:"space-y-1",children:t.map(p=>e.jsxs("div",{className:"ml-2",children:[e.jsxs("button",{type:"button",onClick:()=>a(p.id),className:`w-full text-left px-3 py-4 md:py-2 rounded flex items-center gap-2 transition-all border ${c===p.id?"bg-violet-900/40 border-violet-500 text-white shadow-lg":"bg-slate-900/40 border-transparent text-slate-400 hover:text-violet-200 hover:bg-white/5"}`,children:[c===p.id?e.jsx(ie,{size:18,className:"text-violet-400"}):e.jsx(xe,{size:18}),e.jsx("span",{className:"text-lg md:text-sm font-fantasy tracking-wide break-words whitespace-normal",children:p.name})]}),p.children.length>0&&e.jsx("div",{className:"pl-4 border-l border-violet-900/20 ml-2 mt-1",children:e.jsx(Ve,{nodes:p.children,onSelect:a,selectedId:c})})]},p.id))}),Ge=({node:t,selectedId:a,expandedIds:c,onSelect:p,onToggleExpand:f,isAdmin:x,onAddSubCategory:w,onAddBookToCategory:g})=>{const C=a===t.id,d=c.has(t.id),n=t.children.length>0;return e.jsxs("div",{className:"select-none text-[10px] font-medium leading-none",children:[e.jsxs("div",{className:`
          flex items-start gap-1 py-1 px-1 rounded-sm cursor-pointer transition-all group border
          ${C?"bg-violet-900/30 text-violet-200 border-violet-500/30 shadow-[0_0_10px_rgba(139,92,246,0.1)]":"border-transparent text-slate-400 hover:text-slate-200 hover:bg-white/5"}
        `,children:[e.jsx("button",{onClick:s=>{s.stopPropagation(),f(t.id)},className:`p-0 rounded hover:bg-white/10 mt-0.5 ${n?"opacity-100":"opacity-0 pointer-events-none"}`,children:d?e.jsx(ue,{size:8}):e.jsx(Z,{size:8})}),e.jsxs("div",{className:"flex-1 min-w-0 flex items-start gap-1.5",onClick:()=>p(t.id),children:[e.jsx("div",{className:"mt-0.5 shrink-0",children:d?e.jsx(ie,{size:10,className:"text-violet-400"}):e.jsx(xe,{size:10,className:"text-slate-500"})}),e.jsx("span",{className:"pt-0.5 font-fantasy tracking-wide break-words leading-tight",children:t.name}),x&&t.code&&e.jsx("span",{className:"text-[8px] font-mono text-slate-600 ml-auto whitespace-nowrap",children:t.code})]}),x&&e.jsxs("div",{className:"flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity mt-0.5",children:[e.jsx("button",{onClick:s=>{s.stopPropagation(),g(t.id)},className:"p-0.5 hover:text-green-400 text-slate-500",title:"Add Book",children:e.jsx(Qe,{size:8})}),e.jsx("button",{onClick:s=>{s.stopPropagation(),w(t.id)},className:"p-0.5 hover:text-violet-400 text-slate-500",title:"Add Subcategory",children:e.jsx(ne,{size:8})})]})]}),d&&n&&e.jsx("div",{className:"pl-2 border-l border-violet-900/20 ml-1 mt-0.5 space-y-0.5",children:t.children.map(s=>e.jsx(Ge,{node:s,selectedId:a,expandedIds:c,onSelect:p,onToggleExpand:f,isAdmin:x,onAddSubCategory:w,onAddBookToCategory:g},s.id))})]})},Dt=({book:t,onClose:a,onNavigateToCategory:c})=>{const[p,f]=r.useState(!1),x=r.useRef(null),w=d=>{x.current=d.touches[0].clientX},g=d=>{if(!x.current)return;const n=x.current-d.changedTouches[0].clientX;n>50&&f(!0),n<-50&&f(!1),x.current=null},C=t.effects||t.active||t.active_effects;return e.jsx("div",{className:"fixed left-0 right-0 bottom-0 top-12 md:top-0 z-50 bg-black/95 flex items-center justify-center animate-fadeIn p-0 min-[1150px]:p-4 backdrop-blur-md",onClick:a,children:e.jsxs("div",{className:"relative w-full h-full min-[1150px]:max-w-5xl min-[1150px]:h-[85vh] flex flex-col min-[1150px]:flex-row min-[1150px]:rounded-2xl overflow-hidden border-0 min-[1150px]:border-2 border-violet-500/30 shadow-[0_0_100px_rgba(139,92,246,0.2)] bg-slate-950/60 backdrop-blur-xl isolate",onClick:d=>d.stopPropagation(),onTouchStart:w,onTouchEnd:g,children:[e.jsxs("div",{className:"absolute top-4 right-4 z-50 flex gap-2",children:[t.category&&e.jsx("button",{onClick:()=>{a(),c(t.category)},className:"p-2 text-slate-400 hover:text-violet-300 transition-colors bg-black/40 hover:bg-violet-900/20 rounded-full border border-transparent hover:border-violet-500/30",title:"Назад к разделу",children:e.jsx(bt,{size:20})}),e.jsx("button",{onClick:a,className:"p-2 text-violet-400 hover:text-white transition-colors bg-black/40 hover:bg-violet-900/20 rounded-full",children:e.jsx(ke,{size:24})})]}),e.jsxs("div",{className:"flex-1 p-6 md:p-12 overflow-y-auto custom-scrollbar relative border-r border-violet-500/10",children:[e.jsx("h2",{className:"font-fantasy text-2xl md:text-4xl text-transparent bg-clip-text bg-gradient-to-r from-violet-300 to-slate-200 drop-shadow-[0_0_5px_rgba(139,92,246,0.2)] text-center md:text-left leading-tight break-words pr-12",children:t.title}),e.jsx("div",{className:"h-px w-full bg-gradient-to-r from-transparent via-violet-500/50 to-transparent my-6"}),e.jsx("div",{className:"prose prose-invert prose-violet max-w-none text-slate-300 font-serif leading-loose text-lg whitespace-pre-wrap tracking-wide break-words",children:t.description})]}),C&&e.jsxs("div",{className:`
                absolute inset-y-0 right-0 w-3/4 min-[1150px]:static min-[1150px]:w-1/3 
                bg-black/95 min-[1150px]:bg-black/20 
                p-8 border-l border-violet-500/10 
                flex flex-col gap-6 backdrop-blur-xl min-[1150px]:backdrop-blur-sm 
                transition-transform duration-300 ease-out z-30
                ${p?"translate-x-0 shadow-[-20px_0_50px_rgba(0,0,0,0.8)]":"translate-x-full min-[1150px]:translate-x-0"}
            `,children:[e.jsx("h3",{className:"font-fantasy text-xl text-violet-300/70 uppercase tracking-widest text-center mb-4",children:"Свойства"}),t.effects&&e.jsxs("div",{className:"bg-violet-950/20 border border-violet-500/20 p-4 rounded-lg relative overflow-hidden group",children:[e.jsxs("h4",{className:"text-violet-400 font-bold text-xs uppercase tracking-widest mb-2 flex items-center gap-2",children:[e.jsx(je,{size:12})," Содержит"]}),e.jsx("p",{className:"text-slate-300 font-serif italic break-words",children:t.effects})]}),(t.active||t.active_effects)&&e.jsxs("div",{className:"bg-red-950/10 border border-red-500/20 p-4 rounded-lg relative overflow-hidden group",children:[e.jsxs("h4",{className:"text-red-400 font-bold text-xs uppercase tracking-widest mb-2 flex items-center gap-2",children:[e.jsx(je,{size:12})," Доступно"]}),e.jsx("p",{className:"text-slate-300 font-serif italic break-words",children:t.active_effects})]})]})]})})},Qt=({isAdmin:t=!1})=>{var oe;const{books:a,loading:c,error:p,addBook:f,updateBook:x,deleteBook:w}=Bt(),{categories:g,loading:C}=At(),[d,n]=r.useState(!1),[s,i]=r.useState(null),[o,v]=r.useState(new Set),[u,h]=r.useState("all"),[z,E]=r.useState(null),[$,O]=r.useState(!1),[B,A]=r.useState(!1),[U,Y]=r.useState(!1),[ee,M]=r.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),[N,b]=r.useState({active:!1,category:null}),[y,P]=r.useState(""),[Q,se]=r.useState(null),R=r.useMemo(()=>g.filter(l=>!["Graveyard","Могильник"].includes(l.name)),[g]),q=r.useMemo(()=>Ft(R),[R]),te=r.useMemo(()=>ye(R,s),[R,s]);r.useEffect(()=>{if(s){const l=ye(R,s);v(j=>{const k=new Set(j);return l.forEach(I=>k.add(I.id)),k})}},[s,R]);const V=l=>{v(j=>{const k=new Set(j);return k.has(l)?k.delete(l):k.add(l),k})},W=r.useMemo(()=>{let l=a;return s!==null&&(l=l.filter(j=>j.category===s)),u==="active"?l=l.filter(j=>j.active):u==="inactive"&&(l=l.filter(j=>!j.active)),l},[a,s,u]),_=r.useMemo(()=>s===null?q:R.filter(l=>l.parent_id===s),[R,s,q]),F=async l=>{l.preventDefault(),N.title&&N.description&&N.category&&(N.id?await x(N.id,N):await f(N),O(!1),b({active:!1,category:s}))},D=l=>{b({...l}),O(!0)},re=l=>{E(l),n(!1)},ce=l=>{M({isOpen:!0,title:"Сжечь Свиток",message:"Вы уверены, что хотите уничтожить это знание навсегда?",onConfirm:()=>w(l)})};return c||C?e.jsx("div",{className:"flex items-center justify-center h-full text-violet-500 animate-pulse font-fantasy",children:"Распечатывание Архивов..."}):e.jsxs("div",{className:"h-full flex relative overflow-hidden",children:[z&&e.jsx(Dt,{book:z,onClose:()=>E(null),onNavigateToCategory:l=>{i(l),E(null)}}),e.jsxs("div",{className:`absolute inset-y-0 left-0 z-30 w-full min-[1150px]:w-64 bg-slate-950/90 min-[1150px]:bg-slate-950/40 backdrop-blur-xl border-r border-violet-500/20 shadow-2xl transform transition-transform duration-300 ease-in-out flex flex-col ${d?"translate-x-0":"-translate-x-full"}`,children:[e.jsxs("div",{className:"p-2 border-b border-white/5 flex justify-between items-center shrink-0",children:[e.jsxs("h3",{className:"text-violet-200 font-fantasy text-sm flex items-center gap-2",children:[e.jsx(le,{size:14,className:"text-violet-500"})," Индекс Архива"]}),e.jsx("button",{onClick:()=>n(!1),className:"text-slate-400 hover:text-white p-1",children:e.jsx(Te,{size:16})})]}),e.jsxs("div",{className:"p-1 overflow-y-auto flex-1 custom-scrollbar",children:[e.jsxs("button",{onClick:()=>i(null),className:`w-full text-left px-2 py-1.5 rounded-sm mb-0.5 text-[10px] font-bold flex items-center gap-2 transition-all ${s===null?"bg-violet-600/20 text-white border border-violet-500/30":"text-slate-400 hover:text-slate-200"}`,children:[e.jsx(we,{size:10})," Главная"]}),e.jsx("div",{className:"space-y-0",children:q.map(l=>e.jsx(Ge,{node:l,selectedId:s,expandedIds:o,onToggleExpand:V,onSelect:i,isAdmin:t,onAddSubCategory:j=>{A(!0),se(j)},onAddBookToCategory:j=>{O(!0),b({...N,category:j,id:void 0})}},l.id))})]})]}),e.jsxs("div",{className:`flex-1 flex flex-col transition-all duration-300 ${d?"ml-0 min-[1150px]:ml-64":"ml-0"} h-full overflow-hidden`,children:[e.jsxs("div",{className:"bg-slate-900/90 backdrop-blur-md border-b border-violet-500/20 p-3 shrink-0 z-20 flex flex-wrap gap-3 justify-between items-center shadow-lg min-h-[3.5rem]",children:[e.jsxs("div",{className:"flex items-center gap-4 w-full md:w-auto overflow-hidden",children:[e.jsxs("h2",{onClick:()=>n(!d),className:"text-xl font-fantasy text-transparent bg-clip-text bg-gradient-to-r from-violet-200 to-fuchsia-200 flex items-center gap-2 cursor-pointer select-none hover:brightness-125 transition-all active:scale-95",children:[e.jsx(Ne,{className:"text-violet-500",size:20})," Справочник"]}),e.jsxs("div",{className:"flex items-center text-xs font-fantasy whitespace-nowrap overflow-x-auto custom-scrollbar pb-1",children:[e.jsxs("button",{onClick:()=>i(null),className:"hover:text-violet-400 text-slate-300 px-1 flex items-center gap-1",children:[e.jsx(we,{size:12})," Главная"]}),te.map(l=>e.jsxs(pe.Fragment,{children:[e.jsx(Z,{size:10,className:"mx-1 text-slate-600"}),e.jsx("button",{onClick:()=>i(l.id),className:`hover:text-violet-400 ${l.id===s?"text-violet-300 font-bold underline":"text-slate-300"}`,children:l.name})]},l.id))]})]}),e.jsx("div",{className:"flex gap-2 shrink-0 ml-auto",children:t&&e.jsxs("button",{onClick:()=>{O(!0),b({...N,category:s,id:void 0})},className:"bg-violet-700/80 hover:bg-violet-600 text-white px-2 py-1 rounded text-[10px] uppercase font-bold tracking-wider",children:[e.jsx(ne,{size:10})," Добавить Том"]})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto custom-scrollbar bg-slate-950/40 backdrop-blur-sm p-4 md:p-6",children:[p&&e.jsx("div",{className:"bg-red-900/20 border border-red-500/50 text-red-200 px-4 py-2 rounded mb-6",children:p}),_.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h4",{className:"text-[10px] font-bold uppercase tracking-widest text-violet-300/70 mb-2 border-b border-violet-500/20 pb-1",children:"Разделы"}),e.jsx("div",{className:"grid grid-cols-1 min-[550px]:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:_.map(l=>e.jsxs("div",{onClick:()=>i(l.id),className:"group bg-slate-900/40 border border-slate-700/50 hover:border-violet-500/50 hover:bg-violet-900/20 p-4 rounded-xl flex items-center gap-4 cursor-pointer transition-all shadow-md",children:[e.jsx("div",{className:"p-3 bg-white/5 rounded-lg text-slate-500 group-hover:text-violet-300 shrink-0",children:e.jsx(xe,{size:28})}),e.jsx("div",{className:"overflow-hidden",children:e.jsx("h4",{className:"text-slate-300 text-sm font-medium group-hover:text-violet-100 font-fantasy break-words whitespace-normal leading-tight",children:l.name})})]},l.id))})]}),e.jsx("div",{className:"flex justify-center mb-6",children:e.jsxs("div",{className:"flex items-center bg-slate-950/60 p-1 rounded-xl border border-white/5 backdrop-blur-md",children:[e.jsx("button",{onClick:()=>h("all"),className:`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${u==="all"?"bg-violet-700 text-white":"text-slate-400 hover:text-white"}`,children:"Все"}),e.jsx("button",{onClick:()=>h("active"),className:`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${u==="active"?"bg-violet-700 text-white":"text-slate-400 hover:text-white"}`,children:"Активные"}),e.jsx("button",{onClick:()=>h("inactive"),className:`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${u==="inactive"?"bg-slate-700 text-white":"text-slate-400 hover:text-white"}`,children:"Инфо"})]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 border-b border-violet-500/20 pb-1",children:[e.jsx("h4",{className:"text-[10px] font-bold uppercase tracking-widest text-violet-300/70",children:"Тома"}),e.jsxs("span",{className:"text-[10px] text-slate-500",children:[W.length," записей"]})]}),W.length===0?e.jsxs("div",{className:"text-center py-12 opacity-30 border-2 border-dashed border-slate-700 rounded-lg flex flex-col items-center gap-2",children:[e.jsx(le,{size:32}),e.jsx("p",{className:"font-fantasy text-slate-400 text-sm",children:"Пусто..."})]}):e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 min-[1150px]:grid-cols-6 gap-3 pb-8",children:W.map(l=>e.jsxs("div",{onClick:()=>re(l),className:"group relative aspect-[3/4] bg-slate-900/80 border border-slate-700/50 rounded-lg cursor-pointer transition-all duration-500 hover:border-violet-500/50 overflow-hidden flex flex-col items-center justify-center p-2 text-center isolate",children:[t&&e.jsxs("div",{className:"absolute top-1.5 left-1.5 flex flex-col gap-1 z-20 opacity-0 group-hover:opacity-100",children:[e.jsx("button",{onClick:j=>{j.stopPropagation(),ce(l.id)},className:"p-1 bg-black/50 rounded text-slate-600 hover:text-red-400",children:e.jsx(_e,{size:10})}),e.jsx("button",{onClick:j=>{j.stopPropagation(),D(l)},className:"p-1 bg-black/50 rounded text-slate-600 hover:text-violet-400",children:e.jsx(be,{size:10})})]}),e.jsxs("div",{className:"relative w-8 h-8 md:w-10 md:h-10 mb-2 flex items-center justify-center group-hover:scale-110 transition-transform",children:[e.jsx(Qe,{className:"text-slate-600 group-hover:opacity-0 transition-opacity",strokeWidth:1.5}),e.jsx(le,{className:"absolute inset-0 text-violet-300 opacity-0 group-hover:opacity-100 transition-opacity",strokeWidth:2})]}),e.jsx("div",{className:"relative z-10 w-full",children:e.jsx("h3",{className:"text-xs font-fantasy font-bold text-slate-300 group-hover:text-white leading-tight mb-0.5 break-words whitespace-normal line-clamp-3",children:l.title})})]},l.id))})]})]})]}),e.jsx(K,{isOpen:$,onClose:()=>O(!1),title:N.id?"Переписать Том":"Вписать Новый Том",children:e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsx(Tt,{required:!0,placeholder:"Название",value:N.title||"",onChange:l=>b({...N,title:l.target.value})}),e.jsx("div",{className:"relative",children:e.jsxs("button",{type:"button",onClick:()=>Y(!0),className:"w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 flex items-center justify-between hover:border-violet-500 transition-colors",children:[e.jsx("span",{children:N.category?(oe=g.find(l=>l.id===N.category))==null?void 0:oe.name:"Выберите Классификацию..."}),e.jsx(yt,{size:16,className:"text-violet-500"})]})}),e.jsx(ge,{placeholder:"Пассивные эффекты",rows:2,value:N.effects||"",onChange:l=>b({...N,effects:l.target.value})}),e.jsxs("div",{className:"bg-slate-800/30 p-2 rounded border border-slate-700/50",children:[e.jsx(Rt,{label:"Активная Способность",checked:N.active||!1,onChange:l=>b({...N,active:l})}),N.active&&e.jsx(ge,{rows:2,className:"border-violet-500/30 mt-3",placeholder:"Механика...",value:N.active_effects||"",onChange:l=>b({...N,active_effects:l.target.value})})]}),e.jsx(ge,{required:!0,placeholder:"Содержание",rows:6,value:N.description||"",onChange:l=>b({...N,description:l.target.value})}),e.jsx("button",{type:"submit",className:"w-full mt-4 bg-slate-900 border-2 border-violet-500/50 text-violet-100 font-fantasy py-3 transition-all hover:bg-violet-900/40",children:"Сохранить"})]})}),e.jsx(K,{isOpen:U,onClose:()=>Y(!1),title:"Выбрать Категорию",size:"full",children:e.jsx("div",{className:"h-full overflow-y-auto p-4",children:e.jsx(Ve,{nodes:q,onSelect:l=>{b({...N,category:l}),Y(!1)},selectedId:N.category||null})})})]})};var T=(t=>(t.PERSONAL="Personal",t.FACTION="Faction",t.PUBLIC="Public",t))(T||{}),X=(t=>(t.AVAILABLE="Available",t.IN_PROGRESS="In Progress",t.COMPLETED="Completed",t))(X||{});const Ut=()=>{const[t,a]=r.useState([]),[c,p]=r.useState(!0),f=r.useRef(!1),x=r.useCallback(async()=>{p(!0);try{const{data:n,error:s}=await L.from("quests").select("*");if(s)throw s;const i=(n||[]).map(o=>{var v,u,h;return{id:o.id,title:o.title,description:o.description,reward:o.reward,type:o.type,status:o.status,alignment:((v=o.details)==null?void 0:v.alignment)||o.alignment||"Neutral",details:{givenBy:((u=o.details)==null?void 0:u.givenBy)||"Unknown",acceptedBy:((h=o.details)==null?void 0:h.acceptedBy)||[]},created_at:o.created_at}});a(i)}catch(n){console.error("Error loading quests:",n),a([])}finally{p(!1)}},[]);return r.useEffect(()=>{f.current||(f.current=!0,x())},[x]),{quests:t,loading:c,addQuest:async n=>{var s,i,o;try{const v={title:n.title,description:n.description,reward:n.reward,type:n.type,status:n.status,details:{...n.details,alignment:n.alignment}},{data:u,error:h}=await L.from("quests").insert([v]).select().single();if(h)throw h;if(u){const z={id:u.id,title:u.title,description:u.description,reward:u.reward,type:u.type,status:u.status,alignment:((s=u.details)==null?void 0:s.alignment)||n.alignment||"Neutral",details:{givenBy:((i=u.details)==null?void 0:i.givenBy)||n.details.givenBy,acceptedBy:((o=u.details)==null?void 0:o.acceptedBy)||n.details.acceptedBy},created_at:u.created_at};a(E=>[z,...E])}}catch(v){console.error("Error adding quest:",v)}},editQuest:async(n,s)=>{try{const i=t.find(u=>u.id===n);if(!i)return;const o={title:s.title,description:s.description,reward:s.reward,type:s.type,status:s.status,details:{...i.details||{},...s.details||{},alignment:s.alignment||i.alignment}};a(u=>u.map(h=>h.id===n?{...h,...s,details:o.details,alignment:o.details.alignment}:h));const{error:v}=await L.from("quests").update(o).eq("id",n);if(v)throw v}catch(i){console.error("Error editing quest:",i),x()}},updateStatus:async(n,s)=>{a(i=>i.map(o=>o.id===n?{...o,status:s}:o));try{await L.from("quests").update({status:s}).eq("id",n)}catch(i){console.error("Error updating status:",i),x()}},acceptQuest:async(n,s)=>{const i=t.find(v=>v.id===n);if(!i)return;const o={...i.details,acceptedBy:s,alignment:i.alignment};a(v=>v.map(u=>u.id===n?{...u,status:X.IN_PROGRESS,details:{...u.details,acceptedBy:s}}:u));try{await L.from("quests").update({status:X.IN_PROGRESS,details:o}).eq("id",n)}catch(v){console.error("Error accepting quest:",v),x()}},refresh:x}},Xe=()=>{const[t,a]=r.useState([]),[c,p]=r.useState(!0),f=r.useRef(!1);return r.useEffect(()=>{if(f.current)return;f.current=!0,(async()=>{p(!0);try{const{data:w,error:g}=await L.from("characters").select("id, name, data").order("name");if(g)throw g;a(w||[])}catch(w){console.error("Error loading characters:",w)}finally{p(!1)}})()},[]),{characters:t,loading:c}},ze=({isOpen:t,onClose:a,onConfirm:c,title:p,message:f,confirmText:x="Подтвердить",cancelText:w="Отмена",isDangerous:g=!1})=>e.jsx(K,{isOpen:t,onClose:a,title:p,size:"sm",zIndex:"z-[70]",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:`p-3 rounded-full ${g?"bg-red-900/20 text-red-500":"bg-violet-900/20 text-violet-500"}`,children:e.jsx(rt,{size:32})}),e.jsx("p",{className:"text-slate-300 text-sm leading-relaxed",children:f}),e.jsxs("div",{className:"flex w-full gap-3 pt-2",children:[e.jsx("button",{onClick:a,className:"flex-1 px-4 py-2 rounded bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors text-xs font-bold uppercase tracking-wider",children:w}),e.jsx("button",{onClick:()=>{c(),a()},className:`flex-1 px-4 py-2 rounded text-white transition-colors text-xs font-bold uppercase tracking-wider ${g?"bg-red-900/60 hover:bg-red-800":"bg-violet-700 hover:bg-violet-600"}`,children:x})]})]})}),Ht=({isOpen:t,onClose:a,onConfirm:c,alreadySelected:p})=>{const{characters:f}=Xe(),[x,w]=r.useState(""),[g,C]=r.useState(new Set(p)),[d,n]=r.useState(new Set),s=r.useMemo(()=>{const u={};return f.forEach(h=>{var E,$;const z=(($=(E=h.data)==null?void 0:E.identity)==null?void 0:$.faction)||h.faction||"Uncommon";["graveyard","могильник"].includes(z.toLowerCase())||x&&!h.name.toLowerCase().includes(x.toLowerCase())||(u[z]||(u[z]=[]),u[z].push(h))}),u},[f,x]),i=u=>{const h=new Set(g);h.has(u)?h.delete(u):h.add(u),C(h)},o=u=>{const h=new Set(d);h.has(u)?h.delete(u):h.add(u),n(h)},v=()=>{c(Array.from(g)),a()};return pe.useEffect(()=>{t&&x&&n(new Set(Object.keys(s)))},[x,t,s]),e.jsx(K,{isOpen:t,onClose:a,title:"Список Персонажей",zIndex:"z-[60]",children:e.jsxs("div",{className:"flex flex-col h-[60vh]",children:[e.jsxs("div",{className:"relative mb-4",children:[e.jsx(De,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-500",size:16}),e.jsx("input",{className:"w-full bg-slate-950 border border-slate-700 rounded pl-9 pr-4 py-2 text-white focus:border-violet-500 outline-none",placeholder:"Поиск искателей...",value:x,onChange:u=>w(u.target.value)})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto custom-scrollbar border border-slate-800 rounded bg-slate-900/50 p-2 space-y-2",children:[Object.keys(s).length===0&&e.jsx("div",{className:"text-center text-slate-500 py-4 italic",children:"Активные персонажи не найдены."}),Object.entries(s).map(([u,h])=>{const z=d.has(u)||!!x,E=h.filter($=>g.has($.name)).length;return h.length>0&&h.length,e.jsxs("div",{className:"select-none",children:[e.jsxs("div",{onClick:()=>o(u),className:"flex items-center gap-2 p-2 rounded hover:bg-slate-800 cursor-pointer text-violet-200 font-bold text-sm uppercase tracking-wider bg-slate-950/30 border border-transparent hover:border-slate-700 transition-all",children:[z?e.jsx(ue,{size:14}):e.jsx(Z,{size:14}),e.jsx("span",{children:u}),e.jsxs("span",{className:"ml-auto text-xs text-slate-500 bg-slate-900 px-2 rounded-full border border-slate-800",children:[E," / ",h.length]})]}),z&&e.jsx("div",{className:"ml-4 pl-2 border-l border-slate-700 mt-1 space-y-1",children:h.map($=>{var B,A;const O=g.has($.name);return e.jsxs("div",{onClick:()=>i($.name),className:`flex items-center gap-3 p-2 rounded cursor-pointer transition-colors ${O?"bg-violet-900/30 text-white":"hover:bg-slate-800 text-slate-400"}`,children:[O?e.jsx(ut,{size:16,className:"text-violet-400 shrink-0"}):e.jsx(ht,{size:16,className:"text-slate-600 shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:$.name}),((A=(B=$.data)==null?void 0:B.identity)==null?void 0:A.level)&&e.jsxs("span",{className:"text-[10px] text-slate-600 ml-auto font-mono",children:["Lvl ",$.data.identity.level]})]},$.id)})})]},u)})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-800 flex justify-between items-center",children:[e.jsxs("span",{className:"text-sm text-slate-400",children:["Выбрано: ",e.jsx("span",{className:"text-white font-bold",children:g.size})]}),e.jsxs("button",{onClick:v,className:"bg-violet-700 hover:bg-violet-600 text-white px-6 py-2 rounded font-fantasy flex items-center gap-2",children:[e.jsx(ot,{size:16})," Подтвердить"]})]})]})})},Le=["bg-red-950 border-red-800 text-red-200 shadow-[0_0_8px_rgba(153,27,27,0.5)]","bg-orange-950 border-orange-800 text-orange-200 shadow-[0_0_8px_rgba(154,52,18,0.5)]","bg-amber-950 border-amber-800 text-amber-200 shadow-[0_0_8px_rgba(146,64,14,0.5)]","bg-lime-950 border-lime-800 text-lime-200 shadow-[0_0_8px_rgba(63,98,18,0.5)]","bg-emerald-950 border-emerald-800 text-emerald-200 shadow-[0_0_8px_rgba(6,78,59,0.5)]","bg-cyan-950 border-cyan-800 text-cyan-200 shadow-[0_0_8px_rgba(22,78,99,0.5)]","bg-blue-950 border-blue-800 text-blue-200 shadow-[0_0_8px_rgba(30,58,138,0.5)]","bg-violet-950 border-violet-800 text-violet-200 shadow-[0_0_8px_rgba(76,29,149,0.5)]","bg-fuchsia-950 border-fuchsia-800 text-fuchsia-200 shadow-[0_0_8px_rgba(112,26,117,0.5)]","bg-rose-950 border-rose-800 text-rose-200 shadow-[0_0_8px_rgba(136,19,55,0.5)]"],Oe=(t,a)=>{const c=t.split("").reduce((p,f)=>p+f.charCodeAt(0),0);return Le[(c+a)%Le.length]},me=t=>e.jsx("input",{...t,className:`w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 placeholder-violet-900/40 focus:border-violet-500 focus:shadow-[0_0_15px_rgba(139,92,246,0.3)] outline-none transition-all duration-300 backdrop-blur-sm ${t.className}`}),Vt=t=>e.jsx("textarea",{...t,className:`w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 placeholder-violet-900/40 focus:border-violet-500 focus:shadow-[0_0_15px_rgba(139,92,246,0.3)] outline-none transition-all duration-300 backdrop-blur-sm resize-none ${t.className}`}),ve=t=>e.jsx("select",{...t,className:`w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 focus:border-violet-500 focus:shadow-[0_0_15px_rgba(139,92,246,0.3)] outline-none transition-all duration-300 appearance-none cursor-pointer ${t.className}`,children:t.children}),Gt=({checked:t,onChange:a,label:c})=>e.jsxs("div",{onClick:()=>a(!t),className:"cursor-pointer flex items-center gap-3 select-none group",children:[e.jsxs("div",{className:`relative w-8 h-8 flex items-center justify-center transition-all duration-500 ${t?"scale-110":"scale-100 opacity-60"}`,children:[e.jsx("div",{className:`absolute inset-0 bg-violet-500 blur-md rounded-full transition-opacity duration-500 ${t?"opacity-40":"opacity-0"}`}),e.jsx(He,{size:24,className:`transition-all duration-500 ${t?"text-violet-300 fill-violet-900/80 drop-shadow-[0_0_8px_rgba(167,139,250,0.8)]":"text-slate-600"}`})]}),e.jsx("span",{className:`text-sm font-bold tracking-wide transition-colors ${t?"text-violet-200":"text-slate-500"}`,children:c})]}),We=t=>{const a="backdrop-blur-md border transition-all duration-300";if(t.type===T.PERSONAL)return{container:`${a} bg-emerald-950/40 border-emerald-500/30 hover:border-emerald-400 hover:shadow-[0_0_20px_rgba(16,185,129,0.2)]`,title:"text-emerald-100 drop-shadow-[0_0_5px_rgba(16,185,129,0.5)]",text:"text-emerald-200/80",accent:"bg-emerald-500",glow:"shadow-[0_0_15px_rgba(16,185,129,0.1)]",archiveBorder:"border-emerald-900",archiveText:"text-emerald-400"};if(t.type===T.PUBLIC)return{container:`${a} bg-slate-900/60 border-slate-500/30 hover:border-slate-300 hover:shadow-[0_0_20px_rgba(148,163,184,0.2)]`,title:"text-slate-100 drop-shadow-[0_0_5px_rgba(148,163,184,0.5)]",text:"text-slate-300/80",accent:"bg-slate-400",glow:"shadow-[0_0_15px_rgba(148,163,184,0.1)]",archiveBorder:"border-slate-700",archiveText:"text-slate-400"};switch(t.alignment){case"Dark":return{container:`${a} bg-indigo-950/50 border-indigo-500/40 hover:border-indigo-400 hover:shadow-[0_0_25px_rgba(99,102,241,0.25)]`,title:"text-indigo-100 drop-shadow-[0_0_8px_rgba(99,102,241,0.6)]",text:"text-indigo-200/80",accent:"bg-indigo-500",glow:"shadow-indigo-500/20",archiveBorder:"border-indigo-900",archiveText:"text-indigo-400"};case"Light":return{container:`${a} bg-amber-950/40 border-amber-400/40 hover:border-amber-200 hover:shadow-[0_0_25px_rgba(251,191,36,0.25)]`,title:"text-amber-100 drop-shadow-[0_0_8px_rgba(251,191,36,0.6)]",text:"text-amber-100/80",accent:"bg-amber-400",glow:"shadow-amber-500/20",archiveBorder:"border-amber-900",archiveText:"text-amber-400"};case"NPC":return{container:`${a} bg-red-950/40 border-red-500/40 hover:border-red-400 hover:shadow-[0_0_25px_rgba(239,68,68,0.25)]`,title:"text-red-100 drop-shadow-[0_0_8px_rgba(239,68,68,0.6)]",text:"text-red-200/80",accent:"bg-red-500",glow:"shadow-red-500/20",archiveBorder:"border-red-900",archiveText:"text-red-400"};case"Player":return{container:`${a} bg-cyan-950/40 border-cyan-400/40 hover:border-cyan-200 hover:shadow-[0_0_25px_rgba(34,211,238,0.25)]`,title:"text-cyan-50 drop-shadow-[0_0_8px_rgba(34,211,238,0.6)]",text:"text-cyan-100/80",accent:"bg-cyan-400",glow:"shadow-cyan-500/20",archiveBorder:"border-cyan-900",archiveText:"text-cyan-400"};default:return{container:`${a} bg-fuchsia-950/30 border-fuchsia-500/30 hover:border-fuchsia-300 hover:shadow-[0_0_20px_rgba(217,70,239,0.2)]`,title:"text-fuchsia-100 drop-shadow-[0_0_5px_rgba(217,70,239,0.5)]",text:"text-fuchsia-200/80",accent:"bg-fuchsia-400",glow:"shadow-fuchsia-500/20",archiveBorder:"border-fuchsia-900",archiveText:"text-fuchsia-400"}}},Ye={[T.PERSONAL]:"Личный",[T.FACTION]:"Фракция",[T.PUBLIC]:"Публичный"},Xt=pe.memo(({quest:t,onUpdateStatus:a,onOpenAcceptModal:c,isAdmin:p,onEdit:f,allCharacters:x})=>{const[w,g]=r.useState(!1),[C,d]=r.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),n=t.status===X.IN_PROGRESS,s=We(t),i=o=>{o.stopPropagation(),d({isOpen:!0,title:"Получить Награду",message:"Деяние действительно совершено? Бездна ждет завершения.",onConfirm:()=>a(t.id,X.COMPLETED)})};return e.jsxs("div",{className:"relative group perspective-1000 mb-4 isolate",children:[e.jsx(ze,{isOpen:C.isOpen,onClose:()=>d({...C,isOpen:!1}),onConfirm:C.onConfirm,title:C.title,message:C.message}),e.jsxs("div",{onClick:()=>g(!w),className:`
                    relative z-10 w-full cursor-pointer rounded-xl overflow-hidden
                    ${s.container} ${s.glow}
                    transform hover:-translate-y-1
                `,children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-white/5 to-transparent opacity-0 group-hover:opacity-20 pointer-events-none transition-opacity duration-500"}),e.jsxs("div",{className:"p-4 relative",children:[e.jsxs("div",{className:"flex justify-between items-start gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${s.accent} shadow-[0_0_5px_currentColor]`}),e.jsx("span",{className:`text-[9px] uppercase tracking-[0.2em] font-bold ${s.text} opacity-70`,children:Ye[t.type]})]}),e.jsx("h4",{className:`font-fantasy font-bold text-lg leading-tight ${s.title} break-words`,children:t.title})]}),e.jsx("div",{className:"flex -space-x-2 shrink-0",children:n?t.details.acceptedBy.map((o,v)=>{var z,E,$;const u=x.find(O=>O.name===o),h=((E=(z=u==null?void 0:u.data)==null?void 0:z.identity)==null?void 0:E.avatar_url)||(($=u==null?void 0:u.data)==null?void 0:$.avatar_url);return e.jsx("div",{className:`w-6 h-6 rounded-full border flex items-center justify-center text-[9px] font-bold ring-2 ring-black/50 ${Oe(o,v)} overflow-hidden bg-black`,title:o,children:h?e.jsx("img",{src:h,alt:o,className:"w-full h-full object-cover"}):o.charAt(0)},`${t.id}-pin-${v}`)}):e.jsx("div",{className:"w-6 h-6 rounded-full border border-white/10 bg-white/5 flex items-center justify-center animate-pulse",children:e.jsx(je,{size:10,className:s.text})})})]}),p&&e.jsx("button",{onClick:o=>{o.stopPropagation(),f(t)},className:"absolute top-2 right-2 p-1 text-slate-500 hover:text-white transition-colors opacity-0 group-hover:opacity-100",children:e.jsx(be,{size:12})})]}),e.jsx("div",{className:`
                    bg-black/40
                    transition-all duration-500 ease-in-out overflow-hidden
                    ${w?"max-h-[500px] opacity-100":"max-h-0 opacity-0"}
                `,children:e.jsxs("div",{className:"p-4 pt-0",children:[e.jsx("div",{className:`h-px w-full bg-gradient-to-r from-transparent via-current to-transparent opacity-20 my-3 ${s.text}`}),e.jsx("p",{className:`text-sm leading-relaxed whitespace-pre-wrap font-sans ${s.text} break-words`,children:t.description}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[10px] uppercase tracking-widest text-slate-500 shrink-0",children:"Награда"}),e.jsx("span",{className:`text-xs font-bold ${s.title} break-words`,children:t.reward})]}),n&&t.details.acceptedBy.length>0&&e.jsxs("div",{className:"border-t border-white/5 pt-2 mt-2",children:[e.jsx("span",{className:"text-[10px] uppercase tracking-widest text-slate-500 block mb-1",children:"Приняли"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.details.acceptedBy.map((o,v)=>{var z,E,$;const u=x.find(O=>O.name===o),h=((E=(z=u==null?void 0:u.data)==null?void 0:z.identity)==null?void 0:E.avatar_url)||(($=u==null?void 0:u.data)==null?void 0:$.avatar_url);return e.jsxs("div",{className:"flex items-center gap-1.5 bg-black/20 px-2 py-1 rounded border border-white/5 max-w-full",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${Oe(o,v)} shadow-[0_0_5px_currentColor] overflow-hidden bg-black shrink-0`,children:h&&e.jsx("img",{src:h,alt:o,className:"w-full h-full object-cover"})}),e.jsx("span",{className:`text-xs font-medium ${s.text} truncate`,children:o})]},v)})})]}),e.jsxs("div",{className:"flex justify-between items-end pt-2",children:[e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"text-[10px] uppercase tracking-widest text-slate-500",children:"Заказчик"}),e.jsx("span",{className:`text-xs italic ${s.text} truncate`,children:t.details.givenBy})]}),e.jsxs("div",{className:"flex gap-2",onClick:o=>o.stopPropagation(),children:[t.status===X.AVAILABLE&&e.jsx("button",{onClick:o=>{o.stopPropagation(),c(t.id)},className:"bg-violet-600/80 hover:bg-violet-500 text-white px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wider shadow-[0_0_10px_rgba(139,92,246,0.4)] hover:shadow-[0_0_15px_rgba(139,92,246,0.6)] transition-all border border-violet-400/30 backdrop-blur-sm whitespace-nowrap",children:"Принять Судьбу"}),t.status===X.IN_PROGRESS&&e.jsxs("button",{onClick:i,className:"bg-emerald-600/80 hover:bg-emerald-500 text-white px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wider shadow-[0_0_10px_rgba(16,185,129,0.4)] transition-all border border-emerald-400/30 backdrop-blur-sm flex items-center gap-1 whitespace-nowrap",children:[e.jsx(Ue,{size:12})," Завершить"]})]})]})]})]})})]})]})}),Wt=({isAdmin:t})=>{var ce,oe;const{quests:a,updateStatus:c,addQuest:p,acceptQuest:f,editQuest:x}=Ut(),{characters:w}=Xe(),[g,C]=r.useState(1),d=r.useRef(null),[n,s]=r.useState(!1),[i,o]=r.useState(null),[v,u]=r.useState(!1),[h,z]=r.useState(null),[E,$]=r.useState(!1),[O,B]=r.useState(null),[A,U]=r.useState([""]),[Y,ee]=r.useState(!1),[M,N]=r.useState({type:T.PUBLIC,status:X.AVAILABLE,alignment:"Neutral",details:{givenBy:"",acceptedBy:[]}}),[b,y]=r.useState(!1),P=r.useMemo(()=>w.filter(l=>{var I,ae;const j=((ae=(I=l.data)==null?void 0:I.identity)==null?void 0:ae.faction)||l.faction||"",k=l.name||"";return!(["graveyard","могильник"].includes(j.toLowerCase())||k.includes("Dead")||k.includes("(Dead)"))}),[w]),Q=r.useMemo(()=>{const l={};return P.forEach(j=>{var I,ae;const k=((ae=(I=j.data)==null?void 0:I.identity)==null?void 0:ae.faction)||j.faction||"Uncommon";l[k]||(l[k]=[]),l[k].push(j)}),l},[P]),se=l=>{d.current={x:l.touches[0].clientX,y:l.touches[0].clientY}},R=l=>{if(!d.current)return;const j=d.current.x-l.changedTouches[0].clientX,k=d.current.y-l.changedTouches[0].clientY;Math.abs(j)>Math.abs(k)&&Math.abs(j)>50&&(j>0?C(I=>Math.min(I+1,D.length-1)):C(I=>Math.max(I-1,0))),d.current=null},q=r.useCallback((l,j)=>{c(l,j)},[c]),te=r.useCallback(l=>{B(l),U([""]),$(!0)},[]),V=r.useCallback(l=>{z(l.id),N({...l});const j=w.some(k=>k.name===l.details.givenBy);y(j),u(!0)},[w]),W=l=>{if(l.preventDefault(),M.title&&M.description&&M.details){let j={...M};M.type===T.PERSONAL&&(j.status=X.IN_PROGRESS,j.details={...j.details,acceptedBy:[j.details.givenBy]}),h?x(h,j):p(j),u(!1),z(null),N({type:T.PUBLIC,status:X.AVAILABLE,alignment:"Neutral",details:{givenBy:"",acceptedBy:[]}}),y(!1)}},_=l=>{l.preventDefault();const j=A.filter(k=>k.trim()!=="");O&&j.length>0&&(f(O,j),$(!1))},F=l=>{const j=new Set(A.filter(I=>I.trim()!==""));l.forEach(I=>j.add(I));const k=Array.from(j);k.length===0&&k.push(""),U(k)},D=r.useMemo(()=>[{title:"Личные",type:T.PERSONAL,color:"text-emerald-300",bg:"bg-emerald-900/10"},{title:"Фракционные",type:T.FACTION,color:"text-indigo-300",bg:"bg-indigo-900/10"},{title:"Публичные",type:T.PUBLIC,color:"text-slate-300",bg:"bg-slate-900/10"}],[]),re=r.useMemo(()=>a.filter(l=>l.status===X.COMPLETED),[a]);return e.jsxs("div",{className:"h-full flex flex-col overflow-hidden relative",onTouchStart:se,onTouchEnd:R,children:[e.jsx(Ht,{isOpen:Y,onClose:()=>ee(!1),onConfirm:F,alreadySelected:A}),e.jsxs("div",{className:"bg-slate-900/90 backdrop-blur-md border-b border-violet-500/20 p-3 sticky top-0 z-20 flex flex-wrap gap-3 justify-between items-center shadow-lg shrink-0 min-h-[3.5rem]",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h2",{className:"text-xl font-fantasy text-transparent bg-clip-text bg-gradient-to-r from-violet-200 to-fuchsia-200 flex items-center gap-2 drop-shadow-sm shrink-0",children:[e.jsx(xt,{className:"text-violet-500 drop-shadow-[0_0_8px_rgba(139,92,246,0.8)]",size:20})," Доска Заданий"]}),e.jsx("div",{className:"hidden min-[1150px]:block h-5 w-px bg-white/10"}),e.jsx("div",{className:"hidden min-[1150px]:flex items-center text-xs text-slate-400 font-fantasy tracking-wide",children:e.jsx("span",{children:"Активные Контракты"})})]}),e.jsx("div",{className:"flex min-[1150px]:hidden gap-1.5 mx-auto",children:D.map((l,j)=>e.jsx("div",{className:`w-1.5 h-1.5 rounded-full transition-all duration-300 ${j===g?"bg-violet-400 scale-125 shadow-[0_0_8px_rgba(167,139,250,0.8)]":"bg-slate-700"}`},j))}),t&&e.jsxs("button",{onClick:()=>{z(null),N({type:T.PUBLIC,status:X.AVAILABLE,alignment:"Neutral",details:{givenBy:"",acceptedBy:[]}}),u(!0)},className:"ml-auto group relative bg-violet-900/40 hover:bg-violet-800/60 text-violet-100 border border-violet-500/50 px-3 py-1.5 rounded-lg font-fantasy flex items-center gap-2 transition-all shadow-[0_0_15px_rgba(139,92,246,0.2)] overflow-hidden text-xs md:text-sm",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-violet-500/0 via-violet-400/20 to-violet-500/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"}),e.jsx(ne,{size:16,className:"relative z-10"})," ",e.jsx("span",{className:"hidden sm:inline relative z-10",children:"Создать Квест"})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden relative flex flex-col z-10 bg-black/40 backdrop-blur-sm m-4 rounded-xl border border-slate-700/50 shadow-2xl",children:[e.jsx("div",{className:"absolute inset-0 z-0 opacity-20 pointer-events-none",style:{backgroundImage:"linear-gradient(rgba(139, 92, 246, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(139, 92, 246, 0.1) 1px, transparent 1px)",backgroundSize:"40px 40px"}}),e.jsx("div",{className:"flex-1 flex w-full relative z-10 h-full",children:D.map((l,j)=>e.jsxs("div",{className:`flex-1 h-full flex-col border-r border-slate-700/30 ${l.bg} transition-opacity duration-300 ${j===g?"flex":"hidden min-[1150px]:flex"}`,children:[e.jsxs("div",{className:"p-4 border-b border-white/5 flex items-center justify-center relative",children:[e.jsx("button",{onClick:()=>C(Math.max(0,j-1)),className:`min-[1150px]:hidden absolute left-2 text-slate-500 ${j===0?"opacity-0 pointer-events-none":""}`,children:e.jsx(lt,{})}),e.jsx("h3",{className:`text-center font-fantasy ${l.color} text-lg uppercase tracking-[0.2em] drop-shadow-[0_0_8px_currentColor]`,children:l.title}),e.jsx("button",{onClick:()=>C(Math.min(2,j+1)),className:`min-[1150px]:hidden absolute right-2 text-slate-500 ${j===2?"opacity-0 pointer-events-none":""}`,children:e.jsx(Z,{})}),e.jsx("div",{className:`absolute bottom-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-current to-transparent opacity-50 ${l.color}`})]}),e.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4",children:a.filter(k=>k.type===l.type&&k.status!==X.COMPLETED).map(k=>e.jsx(Xt,{quest:k,onUpdateStatus:q,onOpenAcceptModal:te,isAdmin:t,onEdit:V,allCharacters:w},k.id))})]},l.type))}),e.jsx("button",{onClick:()=>s(!0),className:"absolute bottom-6 right-6 z-30 group",title:"Открыть Архив Бездны",children:e.jsxs("div",{className:"relative w-14 h-14 rounded-full bg-slate-950 border border-slate-700 flex items-center justify-center shadow-2xl overflow-hidden group-hover:scale-110 transition-transform duration-300",children:[e.jsx("div",{className:"absolute inset-0 bg-violet-900/20 group-hover:bg-violet-600/30 transition-colors"}),e.jsx(Ue,{className:"text-emerald-500 group-hover:text-emerald-300 transition-colors relative z-10",size:24}),e.jsx("div",{className:"absolute inset-0 rounded-full animate-ping bg-emerald-500/10"})]})})]}),e.jsxs(K,{isOpen:n,onClose:()=>s(!1),title:"Бездна",zIndex:"z-50",size:"xl",customBg:"bg-[#050b14]/98 border-violet-900/50 shadow-[0_0_60px_rgba(109,40,217,0.3)] backdrop-blur-xl animate-void origin-center",children:[e.jsxs("div",{className:"text-center mb-6 pb-2 relative overflow-hidden rounded-lg p-2",children:[e.jsx("div",{className:"absolute inset-0 opacity-40",style:{backgroundImage:"radial-gradient(white 1px, transparent 1px)",backgroundSize:"15px 15px"}}),e.jsx("div",{className:"relative z-10 font-fantasy text-slate-500 text-sm",children:"Завершенные контракты, вернувшиеся из бездны..."})]}),e.jsx("div",{className:"space-y-4 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar",children:re.length===0?e.jsx("div",{className:"text-center py-12 text-violet-900/50 font-fantasy text-sm",children:"Бездна смотрит в ответ... здесь пусто."}):re.map(l=>{const j=We(l),k=i===l.id;return e.jsxs("div",{onClick:()=>o(k?null:l.id),className:`group relative bg-black/40 border p-4 rounded-lg flex flex-col gap-2 transition-all cursor-pointer hover:bg-white/5 ${j.archiveBorder||"border-slate-800"}`,children:[e.jsxs("div",{className:"flex justify-between items-start relative z-10",children:[e.jsx("span",{className:`font-fantasy font-bold text-lg decoration-violet-800 decoration-1 transition-colors ${j.archiveText||"text-slate-400"} group-hover:brightness-125`,children:l.title}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-[9px] bg-black border border-white/10 px-2 py-0.5 rounded tracking-widest uppercase ${j.archiveText}`,children:Ye[l.type]}),e.jsx(ue,{size:14,className:`text-slate-500 transition-transform ${k?"rotate-180":""}`})]})]}),k&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-white/10 animate-fadeIn space-y-2",children:[e.jsx("p",{className:"text-sm text-slate-400 font-serif leading-relaxed italic",children:l.description}),e.jsxs("div",{className:"flex justify-between items-center text-xs text-slate-500",children:[e.jsxs("span",{children:["Награда: ",e.jsx("span",{className:"text-slate-300",children:l.reward})]}),e.jsxs("span",{children:["От: ",l.details.givenBy]})]})]}),!k&&e.jsxs("div",{className:"flex justify-between items-center mt-2 pt-2 border-t border-white/5",children:[e.jsx("div",{className:"flex -space-x-2",children:l.details.acceptedBy.map((I,ae)=>e.jsx("div",{className:"w-5 h-5 rounded-full border border-slate-900 flex items-center justify-center text-[8px] font-bold text-slate-300 ring-1 ring-slate-800 bg-slate-800",title:I,children:I.charAt(0)},ae))}),e.jsx("span",{className:"text-[10px] text-slate-600 uppercase tracking-widest group-hover:text-slate-500 transition-colors",children:"Исполнено"})]})]},l.id)})})]}),e.jsx(K,{isOpen:v,onClose:()=>u(!1),title:h?"Перековать Квест":"Сотворить Квест",children:e.jsxs("form",{onSubmit:W,className:"space-y-4",children:[e.jsx(me,{required:!0,placeholder:"Название Квеста",value:M.title||"",onChange:l=>N({...M,title:l.target.value})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs text-slate-400",children:"Сфера (Тип)"}),e.jsxs(ve,{value:M.type,onChange:l=>N({...M,type:l.target.value}),children:[e.jsx("option",{value:T.PERSONAL,children:"Личный"}),e.jsx("option",{value:T.FACTION,children:"Фракционный"}),e.jsx("option",{value:T.PUBLIC,children:"Публичный"})]})]}),M.type===T.FACTION&&e.jsxs("div",{className:"space-y-1 animate-fadeIn",children:[e.jsx("label",{className:"text-xs text-slate-400",children:"Аура (Мировоззрение)"}),e.jsxs(ve,{value:M.alignment,onChange:l=>N({...M,alignment:l.target.value}),children:[e.jsx("option",{value:"Neutral",children:"Нейтральный (Фиолетовый)"}),e.jsx("option",{value:"Dark",children:"Тьма (Индиго)"}),e.jsx("option",{value:"Light",children:"Свет (Золотой)"}),e.jsx("option",{value:"NPC",children:"Кровь (Красный)"}),e.jsx("option",{value:"Player",children:"Дух (Голубой)"})]})]})]}),e.jsx(me,{required:!0,placeholder:"Награда",value:M.reward||"",onChange:l=>N({...M,reward:l.target.value})}),e.jsxs("div",{className:"space-y-1 bg-slate-900/30 p-2 rounded border border-slate-800/50",children:[e.jsx("label",{className:"text-xs text-slate-400 block mb-1",children:M.type===T.PERSONAL?"Привязано к Душе":"Происхождение / Покровитель"}),M.type!==T.PERSONAL&&e.jsx("div",{className:"mb-4",children:e.jsx(Gt,{label:"Известный Искатель?",checked:b,onChange:l=>y(l)})}),M.type===T.PERSONAL||b?e.jsxs(ve,{required:!0,value:((ce=M.details)==null?void 0:ce.givenBy)||"",onChange:l=>N({...M,details:{...M.details,givenBy:l.target.value}}),children:[e.jsx("option",{value:"",disabled:!0,children:"Выберите Душу..."}),Object.entries(Q).map(([l,j])=>e.jsx("optgroup",{label:l,children:j.map(k=>e.jsx("option",{value:k.name,children:k.name},k.id))},l))]}):e.jsx(me,{required:!0,placeholder:"Имя Сущности",value:((oe=M.details)==null?void 0:oe.givenBy)||"",onChange:l=>N({...M,details:{...M.details,givenBy:l.target.value}})})]}),e.jsx(Vt,{required:!0,placeholder:"Детали пакта...",rows:3,value:M.description||"",onChange:l=>N({...M,description:l.target.value})}),e.jsxs("button",{type:"submit",className:"w-full mt-4 group relative px-6 py-3 bg-slate-900 border-2 border-violet-500/50 shadow-[0_0_15px_rgba(139,92,246,0.2)] text-violet-100 font-fantasy tracking-[0.2em] uppercase hover:bg-violet-900/40 hover:border-violet-400 hover:shadow-[0_0_25px_rgba(139,92,246,0.6)] transition-all duration-300 overflow-hidden",children:[e.jsx("span",{className:"relative z-10",children:h?"Изменить Реальность":"Воплотить"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-violet-400/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"})]})]})}),e.jsx(K,{isOpen:E,onClose:()=>$(!1),title:"Связать Судьбы",children:e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsx("div",{className:"bg-slate-800/50 p-3 rounded text-sm text-slate-300 italic mb-4 border border-slate-700",children:'"Плетение связывает тех, кто принимает зов..."'}),e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("label",{className:"text-xs text-slate-400 uppercase tracking-widest font-bold",children:"Участники"}),e.jsxs("button",{type:"button",onClick:()=>ee(!0),className:"text-xs flex items-center gap-1 bg-violet-900/20 text-violet-300 px-2 py-1 rounded hover:bg-violet-900/40 transition-colors border border-violet-500/30",children:[e.jsx(le,{size:12})," Список"]})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:A.map((l,j)=>e.jsxs("div",{className:"relative group",children:[e.jsx(me,{autoFocus:j===A.length-1,placeholder:`Душа ${j+1}`,className:"pr-8",value:l,onChange:k=>{const I=[...A];I[j]=k.target.value,U(I)}}),A.length>1&&e.jsx("button",{type:"button",onClick:()=>U(A.filter((k,I)=>I!==j)),className:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-red-500 p-1",children:e.jsx(ke,{size:14})})]},j))}),e.jsxs("button",{type:"button",onClick:()=>U([...A,""]),className:"text-xs flex items-center gap-1 text-slate-400 hover:text-white transition-colors",children:[e.jsx(ne,{size:14})," Добавить участника"]}),e.jsx("button",{type:"submit",className:"w-full mt-4 group relative px-6 py-3 bg-slate-900 border-2 border-violet-500/50 shadow-[0_0_15px_rgba(139,92,246,0.2)] text-violet-100 font-fantasy tracking-[0.2em] uppercase hover:bg-violet-900/40 hover:border-violet-400 hover:shadow-[0_0_25px_rgba(139,92,246,0.6)] transition-all duration-300 overflow-hidden",children:e.jsx("span",{className:"relative z-10",children:"Скрепить Пакт"})})]})})]})},Yt=()=>{const[t,a]=r.useState([]),[c,p]=r.useState(!0),f=r.useRef(!1),x=r.useCallback(async()=>{p(!0);try{const{data:d,error:n}=await L.from("lore_articles").select("*").order("name");if(n)throw n;a(d||[])}catch(d){console.error("Error fetching lore articles:",d)}finally{p(!1)}},[]);return r.useEffect(()=>{f.current||(f.current=!0,x())},[x]),{articles:t,loading:c,addArticle:async d=>{try{const{data:n,error:s}=await L.from("lore_articles").insert([d]).select().single();if(s)throw s;n&&a(i=>[...i,n])}catch(n){console.error("Error adding lore article:",n)}},updateArticle:async(d,n,s,i)=>{a(o=>o.map(v=>v.id===d?{...v,content:n,name:s,category_id:i}:v));try{const{error:o}=await L.from("lore_articles").update({content:n,name:s,category_id:i}).eq("id",d);if(o)throw o}catch(o){console.error("Error updating article:",o),x()}},deleteArticle:async d=>{const n=[...t];a(n.filter(s=>s.id!==d));try{const{error:s}=await L.from("lore_articles").delete().eq("id",d);if(s)throw s}catch(s){console.error("Error deleting article:",s),a(n)}},refresh:x}},qt=()=>{const[t,a]=r.useState([]),[c,p]=r.useState(!0),[f,x]=r.useState(null),w=r.useRef(!1),g=r.useCallback(async()=>{p(!0);try{const{data:s,error:i}=await L.from("lore_categories").select("*").order("name");if(i)throw i;a(s||[])}catch(s){console.error("Error fetching lore categories:",s),x(s.message)}finally{p(!1)}},[]);return r.useEffect(()=>{w.current||(w.current=!0,g())},[g]),{categories:t,loading:c,error:f,addCategory:async s=>{try{const{data:i,error:o}=await L.from("lore_categories").insert([s]).select().single();if(o)throw o;return i&&a(v=>[...v,i].sort((u,h)=>u.name.localeCompare(h.name))),i}catch(i){console.error("Error adding lore category:",i),x(i.message)}},updateCategory:async(s,i)=>{a(o=>o.map(v=>v.id===s?{...v,...i}:v));try{const{error:o}=await L.from("lore_categories").update(i).eq("id",s);if(o)throw o}catch(o){console.error("Error updating lore category:",o),g()}},deleteCategory:async s=>{const i=[...t];a(o=>o.filter(v=>v.id!==s));try{const{error:o}=await L.from("lore_categories").delete().eq("id",s);if(o)throw o}catch(o){console.error("Error deleting lore category:",o),a(i)}},refresh:g}},Jt=t=>{const a=new Map,c=[];return t.forEach(p=>a.set(p.id,{...p,children:[]})),t.forEach(p=>{const f=a.get(p.id);f&&(p.parent_id&&a.has(p.parent_id)?a.get(p.parent_id).children.push(f):c.push(f))}),c},qe=(t,a)=>{if(!a)return[];const c=t.find(p=>p.id===a);return c?c.parent_id?[...qe(t,c.parent_id),c]:[c]:[]},Je=({node:t,selectedCategoryId:a,expandedIds:c,onToggleExpand:p,onSelectCategory:f,articles:x,onSelectArticle:w,selectedArticleId:g,isAdmin:C,onEditCategory:d,onHover:n,onLeave:s})=>{const i=c.has(t.id),o=t.children.length>0,v=x.filter(h=>h.category_id===t.id),u=v.length>0;return e.jsxs("div",{className:"select-none pl-2",children:[e.jsxs("div",{className:`group relative flex items-start gap-1 py-1.5 px-2 rounded cursor-pointer transition-all border border-transparent ${a===t.id?"bg-violet-900/30 text-white border-violet-500/20":"text-slate-400 hover:text-violet-200 hover:bg-white/5"}`,onClick:()=>f(t.id),onMouseEnter:h=>n(h,t.description),onMouseLeave:s,children:[e.jsx("button",{onClick:h=>{h.stopPropagation(),p(t.id)},className:`p-0.5 rounded hover:bg-white/10 mt-0.5 ${o||u?"opacity-100":"opacity-0 pointer-events-none"}`,children:i?e.jsx(ue,{size:12}):e.jsx(Z,{size:12})}),e.jsxs("div",{className:"flex items-start gap-2 flex-1 min-w-0",children:[e.jsx("div",{className:"mt-0.5 shrink-0",children:i?e.jsx(ie,{size:14,className:"text-violet-500"}):e.jsx(xe,{size:14,className:"text-slate-600"})}),e.jsx("span",{className:"font-fantasy tracking-wide text-sm break-words leading-tight pt-0.5",children:t.name})]}),C&&e.jsx("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 mt-0.5",children:e.jsx("button",{onClick:h=>{h.stopPropagation(),d(t)},className:"p-1 hover:text-violet-400 text-slate-500",children:e.jsx(be,{size:10})})})]}),i&&e.jsxs("div",{className:"border-l border-violet-500/10 ml-3",children:[v.map(h=>e.jsxs("div",{onClick:z=>{z.stopPropagation(),w(h.id)},className:`pl-6 py-1 pr-2 text-sm flex items-start gap-2 cursor-pointer transition-colors border-l-2 -ml-[1px] ${g===h.id?"text-violet-300 border-violet-500 bg-violet-500/5 font-bold":"text-slate-500 border-transparent hover:text-slate-300 hover:border-slate-700"}`,children:[e.jsx("div",{className:"mt-0.5 shrink-0",children:e.jsx(Re,{size:14,className:g===h.id?"text-violet-400":"text-slate-600"})}),e.jsx("span",{className:"font-serif italic break-words leading-tight",children:h.name})]},h.id)),t.children.map(h=>e.jsx(Je,{node:h,selectedCategoryId:a,expandedIds:c,onToggleExpand:p,onSelectCategory:f,articles:x,onSelectArticle:w,selectedArticleId:g,isAdmin:C,onEditCategory:d,onHover:n,onLeave:s},h.id))]})]})},Pe=({isAdmin:t})=>{var W;const{articles:a}=Yt(),{categories:c}=qt(),[p,f]=r.useState(null),[x,w]=r.useState(null),[g,C]=r.useState(new Set),[d,n]=r.useState(!0),[s,i]=r.useState(null),[o,v]=r.useState(!1),[u,h]=r.useState(""),[z,E]=r.useState(""),[$,O]=r.useState(!1),[B,A]=r.useState(!1),[U,Y]=r.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),[ee,M]=r.useState({}),[N,b]=r.useState({name:"",description:"",parent_id:null}),y=r.useMemo(()=>a.find(_=>_.id===p),[a,p]),P=r.useMemo(()=>Jt(c),[c]),Q=r.useMemo(()=>qe(c,x||(y==null?void 0:y.category_id)||null),[c,x,y]),se=r.useMemo(()=>x?a.filter(_=>_.category_id===x):a.filter(_=>!_.category_id),[x,a]),R=r.useMemo(()=>x?c.filter(_=>_.parent_id===x):c.filter(_=>!_.parent_id),[c,x]),q=_=>{C(F=>{const D=new Set(F);return D.has(_)?D.delete(_):D.add(_),D})},te=_=>{f(_),v(!1),window.innerWidth<1150&&n(!1)},V=_=>{w(_),f(null),window.innerWidth<1150&&_!==null&&n(!1)};return e.jsxs("div",{className:"h-full flex relative overflow-hidden",children:[e.jsxs("div",{className:`absolute inset-y-0 left-0 z-30 w-full min-[1150px]:w-64 bg-slate-950/90 min-[1150px]:bg-slate-950/40 backdrop-blur-xl border-r border-violet-500/20 shadow-2xl transform transition-transform duration-300 ease-in-out flex flex-col ${d?"translate-x-0":"-translate-x-full"}`,children:[e.jsxs("div",{className:"p-2 border-b border-white/5 flex justify-between items-center shrink-0",children:[e.jsxs("h3",{className:"text-violet-200 font-fantasy text-sm flex items-center gap-2",children:[e.jsx(le,{size:14,className:"text-violet-500"})," Кодекс"]}),e.jsx("button",{onClick:()=>n(!1),className:"text-slate-400 hover:text-white p-1",children:e.jsx(Te,{size:16})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar",children:[e.jsxs("button",{onClick:()=>V(null),className:`w-full text-left px-2 py-2 rounded text-xs font-bold uppercase tracking-widest mb-2 flex items-center gap-2 transition-colors ${x===null?"bg-white/5 text-white":"text-slate-500"}`,children:[e.jsx(De,{size:12})," Главный Архив"]}),P.map(_=>e.jsx(Je,{node:_,selectedCategoryId:x,expandedIds:g,onToggleExpand:q,onSelectCategory:V,articles:a,onSelectArticle:te,selectedArticleId:p,isAdmin:t,onEditCategory:F=>{b({id:F.id,name:F.name,description:F.description||"",parent_id:F.parent_id||null}),A(!0)},onHover:(F,D)=>D&&i({x:F.clientX,y:F.clientY,text:D}),onLeave:()=>i(null)},_.id))]})]}),e.jsxs("div",{className:`flex-1 flex flex-col transition-all duration-300 ${d?"ml-0 min-[1150px]:ml-64":"ml-0"} h-full overflow-hidden`,children:[e.jsx("div",{className:"bg-slate-900/90 backdrop-blur-md border-b border-violet-500/20 p-3 sticky top-0 z-20 flex flex-wrap gap-3 justify-between items-center shadow-lg",children:e.jsxs("div",{className:"flex items-center gap-4 w-full md:w-auto overflow-hidden",children:[e.jsxs("h2",{onClick:()=>n(!d),className:"text-xl font-fantasy text-transparent bg-clip-text bg-gradient-to-r from-violet-200 to-fuchsia-200 flex items-center gap-2 cursor-pointer select-none hover:brightness-125 transition-all active:scale-95",children:[e.jsx(le,{className:"text-violet-500",size:20})," Кодекс"]}),e.jsxs("div",{className:"flex items-center text-xs font-fantasy whitespace-nowrap overflow-x-auto custom-scrollbar pb-1",children:[e.jsxs("button",{onClick:()=>V(null),className:"hover:text-violet-400 text-slate-300 px-1 flex items-center gap-1",children:[e.jsx(Ne,{size:12})," Главный Архив"]}),Q.map(_=>e.jsxs(pe.Fragment,{children:[e.jsx(Z,{size:10,className:"mx-1 text-slate-600"}),e.jsx("button",{onClick:()=>V(_.id),className:`hover:text-violet-400 ${_.id===x?"text-violet-300 font-bold underline":"text-slate-300"}`,children:_.name})]},_.id))]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar p-6",children:y?e.jsxs("article",{className:"prose prose-invert prose-violet max-w-none mx-auto pb-20 break-words",children:[e.jsx("h1",{className:"font-fantasy text-3xl md:text-5xl text-transparent bg-clip-text bg-gradient-to-r from-violet-200 to-white pb-2 leading-tight break-words",children:y.name}),e.jsx("div",{className:"text-slate-200/90 leading-loose whitespace-pre-wrap font-serif text-lg tracking-wide mt-8 break-words",children:y.content})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-3xl font-fantasy text-violet-200 mb-6 border-b border-violet-500/30 pb-2 flex items-center gap-3",children:x?(W=c.find(_=>_.id===x))==null?void 0:W.name:"Главный Архив"}),R.length>0&&e.jsx("div",{className:"grid grid-cols-1 min-[550px]:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:R.map(_=>e.jsxs("div",{onClick:()=>V(_.id),className:"group bg-slate-900/40 border border-slate-700/50 hover:border-violet-500/50 p-4 rounded-xl flex items-center gap-4 cursor-pointer transition-all shadow-md",children:[e.jsx("div",{className:"p-3 bg-white/5 rounded-lg text-slate-500 group-hover:text-violet-300 shrink-0",children:e.jsx(xe,{size:28})}),e.jsx("div",{className:"overflow-hidden",children:e.jsx("h4",{className:"text-slate-300 text-sm font-medium font-fantasy break-words whitespace-normal leading-tight group-hover:text-violet-100",children:_.name})})]},_.id))}),se.length>0&&e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsx("h3",{className:"text-sm font-bold uppercase text-slate-500 tracking-widest mb-2 mt-4 border-b border-white/5 pb-1",children:"Статьи"}),se.map(_=>e.jsxs("div",{onClick:()=>te(_.id),className:"flex items-center gap-3 p-3 bg-slate-900/30 border border-slate-800 rounded hover:bg-violet-900/20 hover:border-violet-500/30 cursor-pointer transition-all group",children:[e.jsx(Re,{size:18,className:"text-slate-500 group-hover:text-violet-400"}),e.jsx("span",{className:"font-serif text-slate-300 group-hover:text-white",children:_.name})]},_.id))]}),R.length===0&&se.length===0&&e.jsx("div",{className:"text-center text-slate-600 italic py-10",children:"В этом разделе пусто..."})]})})]})]})},Ke=()=>{const[t,a]=r.useState([]),[c,p]=r.useState(!0),f=r.useRef(!1),x=r.useCallback(async()=>{p(!0);try{const{data:d,error:n}=await L.from("locations").select("*").order("name");if(n)throw n;a(d||[])}catch(d){console.error("Error fetching locations:",d)}finally{p(!1)}},[]);return r.useEffect(()=>{f.current||(f.current=!0,x())},[x]),{locations:t,loading:c,addLocation:async d=>{try{const{data:n,error:s}=await L.from("locations").insert([d]).select().single();if(s)throw s;n&&a(i=>[...i,n])}catch(n){console.error("Error adding location:",n)}},updateLocation:async(d,n)=>{a(s=>s.map(i=>i.id===d?{...i,...n}:i));try{const{error:s}=await L.from("locations").update(n).eq("id",d);if(s)throw s}catch(s){console.error("Error updating location:",s),x()}},deleteLocation:async d=>{const n=[...t];a(s=>s.filter(i=>i.id!==d));try{const{error:s}=await L.from("locations").delete().eq("id",d);if(s)throw s}catch(s){console.error("Error deleting location:",s),a(n)}}}},Ze=()=>{const[t,a]=r.useState([]),[c,p]=r.useState(!0),f=r.useRef(!1),x=r.useCallback(async()=>{p(!0);try{const{data:d,error:n}=await L.from("maps").select("*").order("name");if(n)throw n;const s=(d||[]).map(i=>({...i,markers:Array.isArray(i.markers)?i.markers:[]}));a(s)}catch(d){console.error("Error fetching maps:",d)}finally{p(!1)}},[]);return r.useEffect(()=>{f.current||(f.current=!0,x())},[x]),{maps:t,loading:c,addMap:async d=>{try{const n={...d,markers:[]},{data:s,error:i}=await L.from("maps").insert([n]).select().single();if(i)throw i;s&&a(o=>[...o,{...s,markers:[]}])}catch(n){console.error("Error adding map:",n)}},updateMap:async(d,n)=>{a(s=>s.map(i=>i.id===d?{...i,...n}:i));try{const{error:s}=await L.from("maps").update(n).eq("id",d);if(s)throw s}catch(s){console.error("Error updating map:",s),x()}},updateMapMarkers:async(d,n)=>{a(s=>s.map(i=>i.id===d?{...i,markers:n}:i));try{const{error:s}=await L.from("maps").update({markers:n}).eq("id",d);if(s)throw s}catch(s){console.error("Error updating markers:",s),x()}},refresh:x}},Ie=t=>e.jsx("input",{...t,className:`w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 placeholder-violet-900/40 focus:border-violet-500 focus:shadow-[0_0_15px_rgba(139,92,246,0.3)] outline-none transition-all duration-300 backdrop-blur-sm ${t.className}`}),Kt=t=>e.jsx("textarea",{...t,className:`w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 placeholder-violet-900/40 focus:border-violet-500 focus:shadow-[0_0_15px_rgba(139,92,246,0.3)] outline-none transition-all duration-300 backdrop-blur-sm resize-none ${t.className}`}),Zt=t=>e.jsx("select",{...t,className:`w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 focus:border-violet-500 focus:shadow-[0_0_15px_rgba(139,92,246,0.3)] outline-none transition-all duration-300 appearance-none cursor-pointer ${t.className}`,children:t.children}),et=t=>{const a=new Map,c=[];return t.forEach(p=>a.set(p.id,{...p,children:[]})),t.forEach(p=>{const f=a.get(p.id);f&&(p.parent&&a.has(p.parent)?a.get(p.parent).children.push(f):c.push(f))}),c},Me=({node:t,level:a,onSelect:c,selectedId:p})=>{const[f,x]=r.useState(!1),w=t.children.length>0;return e.jsxs("div",{className:"select-none",children:[e.jsxs("div",{className:`
                    flex items-center gap-2 p-2 rounded cursor-pointer transition-colors border border-transparent
                    ${p===t.id?"bg-violet-900/40 border-violet-500/50 text-white":"hover:bg-slate-800 text-slate-400"}
                `,style:{marginLeft:`${a*16}px`},onClick:()=>c(t.id),children:[e.jsx("button",{onClick:g=>{g.stopPropagation(),x(!f)},className:`p-1 rounded hover:bg-white/10 ${w?"opacity-100":"opacity-0 pointer-events-none"}`,children:f?e.jsx(ue,{size:14}):e.jsx(Z,{size:14})}),p===t.id?e.jsx(ie,{size:16,className:"text-violet-400"}):e.jsx(xe,{size:16}),e.jsx("span",{className:"font-fantasy tracking-wide text-sm",children:t.name})]}),f&&w&&e.jsx("div",{className:"border-l border-slate-800 ml-4",children:t.children.map(g=>e.jsx(Me,{node:g,level:a+1,onSelect:c,selectedId:p},g.id))})]})},tt=({location:t,parentName:a,subLocations:c,onClose:p,onOpenSubLocation:f,onOpenMap:x})=>e.jsx("div",{className:"fixed left-0 right-0 bottom-0 top-12 md:top-0 z-50 bg-black/95 flex items-center justify-center animate-fadeIn p-0 min-[1150px]:p-6 backdrop-blur-xl",onClick:p,children:e.jsxs("div",{className:"relative w-full h-full min-[1150px]:max-w-6xl min-[1150px]:h-[85vh] bg-slate-950 border border-violet-900/30 rounded-none min-[1150px]:rounded-2xl shadow-2xl flex flex-col min-[1150px]:flex-row overflow-hidden",onClick:w=>w.stopPropagation(),children:[e.jsx("button",{onClick:p,className:"absolute top-4 right-4 z-50 p-2 bg-black/60 text-white rounded-full hover:bg-red-900/80 transition-colors backdrop-blur-md",children:e.jsx(ke,{size:24})}),e.jsxs("div",{className:"w-full min-[1150px]:w-3/5 h-1/3 min-[1150px]:h-full relative shrink-0 bg-black",children:[e.jsx("img",{src:t.img,alt:t.name,className:"w-full h-full object-cover opacity-90"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t min-[1150px]:bg-gradient-to-r from-slate-950 via-transparent to-transparent"}),a&&e.jsx("div",{className:"absolute top-4 left-4 min-[1150px]:bottom-8 min-[1150px]:top-auto min-[1150px]:left-8 px-3 py-1 bg-black/60 backdrop-blur-md border border-violet-500/30 rounded text-violet-300 text-xs uppercase tracking-widest font-bold",children:a}),t.associated_map_id&&e.jsx("div",{className:"absolute bottom-4 left-4 right-4 min-[1150px]:bottom-8 min-[1150px]:left-auto min-[1150px]:right-8 flex justify-center",children:e.jsxs("button",{onClick:()=>x(t.associated_map_id),className:"bg-slate-900/80 hover:bg-violet-600/90 text-white px-6 py-3 rounded-lg flex items-center gap-3 backdrop-blur-md border border-violet-500/50 shadow-[0_0_20px_rgba(139,92,246,0.3)] transition-all font-fantasy tracking-wider uppercase group",children:[e.jsx(Se,{size:18})," Открыть Карту Региона",e.jsx(Z,{size:14,className:"group-hover:translate-x-1 transition-transform"})]})})]}),e.jsxs("div",{className:"w-full min-[1150px]:w-2/5 flex-1 p-6 md:p-10 overflow-y-auto custom-scrollbar bg-slate-950 relative",children:[e.jsx("div",{className:"absolute top-0 right-0 p-10 opacity-10 pointer-events-none",children:e.jsx(Ce,{size:120})}),e.jsx("h1",{className:"text-4xl md:text-5xl font-fantasy text-transparent bg-clip-text bg-gradient-to-r from-white to-violet-400 mb-6 drop-shadow-lg leading-tight break-words",children:t.name}),e.jsx("div",{className:"h-1 w-24 bg-violet-600 mb-8 shadow-[0_0_15px_rgba(139,92,246,0.6)]"}),e.jsx("div",{className:"prose prose-invert prose-violet max-w-none text-lg text-slate-300 leading-loose font-serif whitespace-pre-wrap mb-8 break-words",children:t.description}),c.length>0&&e.jsxs("div",{className:"border-t border-violet-900/30 pt-6",children:[e.jsxs("h4",{className:"text-sm font-fantasy text-violet-400 uppercase tracking-widest mb-4 flex items-center gap-2",children:[e.jsx(ie,{size:14})," Содержит Локации"]}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:c.map(w=>e.jsxs("button",{onClick:()=>f(w),className:"flex items-center gap-3 p-3 rounded bg-slate-900/50 hover:bg-violet-900/20 border border-slate-800 hover:border-violet-500/40 transition-all text-left group",children:[e.jsx("div",{className:"w-10 h-10 rounded overflow-hidden shrink-0 border border-slate-700",children:e.jsx("img",{src:w.img,alt:"",className:"w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity"})}),e.jsx("div",{className:"flex-1",children:e.jsx("div",{className:"font-fantasy text-slate-300 group-hover:text-white transition-colors",children:w.name})}),e.jsx(Z,{size:14,className:"text-slate-600 group-hover:text-violet-400 transition-colors"})]},w.id))})]})]})]})}),es=({isAdmin:t,onNavigateToMap:a})=>{const{locations:c,addLocation:p,updateLocation:f,deleteLocation:x}=Ke(),{maps:w}=Ze(),[g,C]=r.useState(!1),[d,n]=r.useState({}),[s,i]=r.useState(!1),[o,v]=r.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),[u,h]=r.useState(null),[z,E]=r.useState(null),$=r.useMemo(()=>et(c),[c]),O=r.useMemo(()=>{const b=[];let y=u;for(;y;){const P=c.find(Q=>Q.id===y);if(P)b.unshift(P),y=P.parent||null;else break}return b},[u,c]),B=r.useMemo(()=>c.filter(b=>b.parent===(u||null)),[c,u]),A=b=>{if(b.preventDefault(),d.name&&d.description){const y={...d};!y.id&&!y.parent&&u&&(y.parent=u),y.id?f(y.id,y):p(y),C(!1),n({})}},U=b=>{n({...b}),C(!0)},Y=b=>{v({isOpen:!0,title:"Удалить Локацию",message:"Вы уверены? Это действие необратимо.",onConfirm:()=>x(b)})},ee=()=>{n({parent:u}),C(!0)},M=b=>{var y;return b?(y=c.find(P=>P.id===b))==null?void 0:y.name:null},N=b=>{c.some(P=>P.parent===b.id)?(E(null),h(b.id)):E(b)};return e.jsxs("div",{className:"h-full flex flex-col",children:[z&&e.jsx(tt,{location:z,parentName:M(z.parent)||void 0,subLocations:c.filter(b=>b.parent===z.id),onClose:()=>E(null),onOpenSubLocation:N,onOpenMap:a}),e.jsxs("div",{className:"bg-slate-900/90 backdrop-blur-md border-b border-violet-500/20 p-3 sticky top-0 z-20 flex flex-wrap justify-between items-center shadow-lg shrink-0 min-h-[3.5rem] gap-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 overflow-hidden w-full md:w-auto",children:[e.jsxs("h2",{className:"text-xl font-fantasy text-transparent bg-clip-text bg-gradient-to-r from-violet-200 to-fuchsia-200 flex items-center gap-2 drop-shadow-sm shrink-0 pr-4 sm:border-r border-white/10",children:[e.jsx(Ce,{className:"text-violet-500 drop-shadow-[0_0_8px_rgba(139,92,246,0.8)]",size:20})," Известный Мир"]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs font-fantasy overflow-x-auto custom-scrollbar pb-1",children:[e.jsxs("button",{onClick:()=>h(null),className:`flex items-center gap-1 transition-colors whitespace-nowrap ${u?"text-slate-500 hover:text-white":"text-violet-400 font-bold"}`,children:[e.jsx(we,{size:12})," Материальный План"]}),O.map((b,y)=>e.jsxs(pe.Fragment,{children:[e.jsx(Z,{size:10,className:"text-slate-600 shrink-0"}),e.jsx("button",{onClick:()=>h(b.id),className:`whitespace-nowrap transition-colors ${y===O.length-1?"text-violet-400 font-bold":"text-slate-500 hover:text-white"}`,children:b.name})]},b.id))]})]}),t&&e.jsxs("button",{onClick:ee,className:"ml-auto bg-violet-900/30 hover:bg-violet-800/50 text-violet-100 px-3 py-1.5 rounded-lg flex gap-2 items-center border border-violet-500/30 transition-all font-fantasy uppercase tracking-wider text-[10px] md:text-xs",children:[e.jsx(ne,{size:14})," Открыть"]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 relative",children:[u&&e.jsxs("button",{onClick:()=>{const b=c.find(y=>y.id===u);h((b==null?void 0:b.parent)||null)},className:"mb-4 flex items-center gap-2 text-slate-400 hover:text-violet-300 transition-colors text-xs font-bold uppercase tracking-wider",children:[e.jsx(jt,{size:14})," Вернуться в Регион"]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 pb-10",children:B.length===0?e.jsx("div",{className:"col-span-full text-center py-20 text-slate-600 italic font-fantasy border-2 border-dashed border-slate-800 rounded-xl",children:"Неизведанная Территория..."}):B.map(b=>{const y=c.some(P=>P.parent===b.id);return e.jsxs("div",{className:"group relative flex flex-col h-auto rounded-xl shadow-lg bg-black/40 backdrop-blur-sm border border-slate-800/50 hover:border-violet-500/50 transition-all hover:-translate-y-2",children:[e.jsxs("div",{onClick:()=>E(b),className:"relative h-64 w-full cursor-pointer overflow-hidden rounded-t-xl",children:[e.jsx("img",{src:b.img,alt:b.name,className:"w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110 opacity-60 group-hover:opacity-100"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent opacity-90"}),e.jsx("div",{className:"absolute top-2 left-2 z-20 bg-black/60 p-1.5 rounded-full text-violet-400 border border-violet-500/30 backdrop-blur-md shadow-[0_0_10px_rgba(139,92,246,0.5)]",children:y?e.jsx(ie,{size:14}):e.jsx(Fe,{size:14})}),t&&e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1 z-20 opacity-0 group-hover:opacity-100 transition-all",children:[e.jsx("button",{onClick:P=>{P.stopPropagation(),U(b)},className:"p-2 bg-black/60 text-slate-400 hover:text-white rounded-full hover:bg-violet-900/50",children:e.jsx(be,{size:14})}),e.jsx("button",{onClick:P=>{P.stopPropagation(),Y(b.id)},className:"p-2 bg-black/60 text-slate-400 hover:text-red-400 rounded-full hover:bg-red-900/50",children:e.jsx(_e,{size:14})})]}),e.jsxs("div",{className:"absolute bottom-0 p-5 w-full z-10 pointer-events-none",children:[e.jsx("div",{className:"h-0.5 w-12 bg-violet-500 mb-3 shadow-[0_0_10px_rgba(139,92,246,1)] group-hover:w-full transition-all duration-700"}),e.jsx("h3",{className:"text-xl font-fantasy text-slate-200 group-hover:text-white transition-colors drop-shadow-md truncate flex items-center gap-2",children:b.name}),e.jsx("span",{className:"text-[10px] text-slate-500 uppercase tracking-widest",children:y?"Регион":"Локация"})]}),e.jsx("div",{className:"absolute inset-0 border-2 border-transparent group-hover:border-violet-500/30 rounded-t-xl pointer-events-none transition-colors duration-500 z-10"})]}),y&&e.jsxs("button",{onClick:P=>{P.stopPropagation(),h(b.id)},className:"w-full bg-slate-900 hover:bg-violet-900/40 border-t border-slate-700 hover:border-violet-500/50 p-3 flex items-center justify-center gap-2 text-xs font-fantasy uppercase tracking-wider text-slate-400 hover:text-white transition-all group/btn rounded-b-xl relative z-20",children:["Войти в Регион ",e.jsx(Z,{size:14,className:"group-hover/btn:translate-x-1 transition-transform"})]}),!y&&e.jsx("div",{className:"hidden"})]},b.id)})})]}),e.jsx(K,{isOpen:g,onClose:()=>C(!1),title:d.id?"Редактировать Локацию":"Новая Локация",children:e.jsxs("form",{onSubmit:A,className:"space-y-4",children:[e.jsx(Ie,{required:!0,placeholder:"Название",value:d.name||"",onChange:b=>n({...d,name:b.target.value})}),e.jsx("div",{className:"relative",children:e.jsxs("button",{type:"button",onClick:()=>i(!0),className:"w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 flex items-center justify-between hover:border-violet-500 transition-colors",children:[e.jsx("span",{className:d.parent?"":"text-violet-900/40",children:d.parent?M(d.parent):"Выберите Регион..."}),e.jsx(ie,{size:16,className:"text-violet-500"})]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs text-slate-500 uppercase tracking-wide",children:"Связанная Карта"}),e.jsxs(Zt,{value:d.associated_map_id||"",onChange:b=>n({...d,associated_map_id:b.target.value||null}),children:[e.jsx("option",{value:"",children:"-- Нет Карты --"}),w.map(b=>e.jsx("option",{value:b.id,children:b.name},b.id))]})]}),e.jsx(Ie,{placeholder:"URL Изображения",value:d.img||"",onChange:b=>n({...d,img:b.target.value})}),e.jsx(Kt,{required:!0,placeholder:"Описание",rows:3,value:d.description||"",onChange:b=>n({...d,description:b.target.value})}),e.jsxs("button",{type:"submit",className:"w-full mt-4 group relative px-6 py-3 bg-slate-900 border-2 border-violet-500/50 shadow-[0_0_15px_rgba(139,92,246,0.2)] text-violet-100 font-fantasy tracking-[0.2em] uppercase hover:bg-violet-900/40 hover:border-violet-400 hover:shadow-[0_0_25px_rgba(139,92,246,0.6)] transition-all duration-300 overflow-hidden",children:[e.jsx("span",{className:"relative z-10",children:d.id?"Обновить Записи":"Записать Локацию"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-violet-400/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"})]})]})}),e.jsx(K,{isOpen:s,onClose:()=>i(!1),title:"Выберите Родительский Регион",children:e.jsxs("div",{className:"h-[50vh] overflow-y-auto custom-scrollbar border border-slate-800 rounded bg-slate-900/50 p-4 space-y-1",children:[e.jsx("button",{onClick:()=>{n({...d,parent:null}),i(!1)},className:"w-full text-left p-2 hover:bg-slate-800 text-slate-400 text-sm mb-2 border-b border-slate-800 pb-2",children:"[Материальный План]"}),$.map(b=>e.jsx(Me,{node:b,level:0,onSelect:y=>{n({...d,parent:y}),i(!1)},selectedId:d.parent||null},b.id))]})}),e.jsx(ze,{isOpen:o.isOpen,title:o.title,message:o.message,onClose:()=>v(b=>({...b,isOpen:!1})),onConfirm:o.onConfirm,isDangerous:!0})]})},ts=["#ef4444","#f97316","#f59e0b","#84cc16","#10b981","#06b6d4","#3b82f6","#8b5cf6","#d946ef","#f43f5e","#ffffff"],Be=t=>e.jsx("input",{...t,className:`w-full bg-[#020408] border border-violet-900/40 p-2.5 rounded-lg text-violet-100 placeholder-violet-900/40 focus:border-violet-500 focus:shadow-[0_0_15px_rgba(139,92,246,0.3)] outline-none transition-all duration-300 backdrop-blur-sm ${t.className}`}),ss=({isAdmin:t,initialMapId:a})=>{var Ee;const{maps:c,loading:p,updateMapMarkers:f,addMap:x,updateMap:w}=Ze(),{locations:g}=Ke(),[C,d]=r.useState(a||null);r.useEffect(()=>{a&&d(a)},[a]),r.useEffect(()=>{!C&&c.length>0&&d(c[0].id)},[c,C]);const n=c.find(m=>m.id===C),[s,i]=r.useState(!1),[o,v]=r.useState(null),[u,h]=r.useState(null),[z,E]=r.useState("existing"),[$,O]=r.useState(!1),[B,A]=r.useState({id:"",name:"",image_url:""}),[U,Y]=r.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),[ee,M]=r.useState(null),[N,b]=r.useState({name:"",description:""}),[y,P]=r.useState({color:"#8b5cf6",brightness:1}),[Q,se]=r.useState(!1),[R,q]=r.useState(null),te=r.useRef(null),[V,W]=r.useState(null),_=r.useMemo(()=>et(g),[g]),[F,D]=r.useState([]);r.useEffect(()=>{n&&D(n.markers||[])},[n]);const re=m=>{if(!te.current)return null;const S=te.current.getBoundingClientRect();let J,G;"touches"in m?(J=m.touches[0].clientX,G=m.touches[0].clientY):(J=m.clientX,G=m.clientY);const he=(J-S.left)/S.width*100,de=(G-S.top)/S.height*100;return{x:Math.min(100,Math.max(0,he)),y:Math.min(100,Math.max(0,de))}},ce=m=>{if(!t||!n||Q||m.target.closest(".map-pin"))return;const S=re(m);S&&(h(S),v(null),M(null),b({name:"",description:""}),P({color:"#8b5cf6",brightness:1}),E("existing"),i(!0))},oe=(m,S)=>{if(m.stopPropagation(),Q&&t)v(S.id),h({x:S.x,y:S.y}),M(S.locationId||null),b({name:S.label||"",description:S.description||""}),P({color:S.color||"#8b5cf6",brightness:S.brightness||1}),E(S.locationId?"existing":"new"),i(!0);else if(S.locationId){const J=g.find(G=>G.id===S.locationId);J&&W(J)}},l=(m,S)=>{Q&&t&&(m.stopPropagation(),q(S))},j=m=>{if(R&&Q){const S=re(m);S&&D(J=>J.map(G=>G.id===R?{...G,x:S.x,y:S.y}:G))}},k=async()=>{R&&n&&(await f(n.id,F),q(null))},I=async()=>{var he;if(!n||!u)return;let m=ee,S=((he=g.find(de=>de.id===ee))==null?void 0:he.name)||"Неизвестно";z==="new"&&N.name&&(S=N.name,m=null);const J={id:o||crypto.randomUUID(),x:u.x,y:u.y,label:S,locationId:m,description:N.description,color:y.color,brightness:y.brightness};let G;o?G=F.map(de=>de.id===o?J:de):G=[...F,J],D(G),await f(n.id,G),i(!1)},ae=async m=>{m.preventDefault(),B.name&&B.image_url&&(B.id?await w(B.id,{name:B.name,image_url:B.image_url}):await x({name:B.name,image_url:B.image_url}),O(!1),A({id:"",name:"",image_url:""}))},st=m=>{m.stopPropagation(),n&&(A({id:n.id,name:n.name,image_url:n.image_url}),O(!0))},at=()=>{!t||!n||!o||Y({isOpen:!0,title:"Удалить Метку",message:"Удалить эту метку с карты?",onConfirm:async()=>{const m=F.filter(S=>S.id!==o);D(m),await f(n.id,m),i(!1)}})};return p?e.jsx("div",{className:"p-8 text-violet-400 font-fantasy animate-pulse",children:"Разворачивание свитков..."}):e.jsxs("div",{className:"h-full flex flex-col",onMouseMove:j,onMouseUp:k,onTouchMove:j,onTouchEnd:k,children:[V&&e.jsx(tt,{location:V,parentName:(Ee=g.find(m=>m.id===V.parent))==null?void 0:Ee.name,subLocations:g.filter(m=>m.parent===V.id),onClose:()=>W(null),onOpenSubLocation:m=>W(m),onOpenMap:m=>d(m)}),e.jsxs("div",{className:"bg-slate-900/90 backdrop-blur-md border-b border-violet-500/20 p-3 sticky top-0 z-20 flex flex-wrap gap-3 justify-between items-center shadow-lg shrink-0 min-h-[3.5rem]",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("h2",{className:"text-xl font-fantasy text-transparent bg-clip-text bg-gradient-to-r from-violet-200 to-fuchsia-200 flex items-center gap-2 drop-shadow-sm shrink-0 pr-4 border-r border-white/10",children:[e.jsx(Se,{className:"text-violet-500 drop-shadow-[0_0_8px_rgba(139,92,246,0.8)]",size:20})," Картография"]}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[c.map(m=>e.jsxs("div",{className:"relative group/mapbtn",children:[e.jsx("button",{onClick:()=>d(m.id),className:`whitespace-nowrap px-3 py-1 rounded text-xs font-fantasy tracking-wider transition-all border flex items-center gap-2 ${(n==null?void 0:n.id)===m.id?"bg-violet-600/20 border-violet-500 text-white shadow-[0_0_10px_rgba(139,92,246,0.3)]":"border-transparent text-slate-500 hover:text-slate-300 hover:bg-white/5"}`,children:m.name}),t&&(n==null?void 0:n.id)===m.id&&e.jsx("button",{onClick:st,className:"absolute -top-2 -right-2 p-1 bg-black rounded-full border border-slate-700 text-slate-400 hover:text-white opacity-0 group-hover/mapbtn:opacity-100 transition-opacity",title:"Edit Map Details",children:e.jsx($t,{size:10})})]},m.id)),t&&e.jsx("button",{onClick:()=>{A({id:"",name:"",image_url:""}),O(!0)},className:"p-1 rounded bg-violet-900/30 text-violet-400 border border-violet-500/30 hover:bg-violet-800/50 hover:text-white transition-all shrink-0",title:"Add Map",children:e.jsx(ne,{size:14})})]})]}),t?e.jsx("div",{className:"flex items-center gap-2 ml-auto",children:e.jsx("button",{onClick:()=>se(!Q),className:`flex items-center gap-2 px-3 py-1 rounded text-[10px] font-bold uppercase tracking-wider border transition-all ${Q?"bg-red-900/50 border-red-500 text-white animate-pulse":"bg-slate-900/50 border-slate-700 text-slate-400"}`,children:Q?e.jsxs(e.Fragment,{children:[e.jsx(pt,{size:12})," Завершить"]}):e.jsxs(e.Fragment,{children:[e.jsx(it,{size:12})," Ред. Метки"]})})}):e.jsx("div",{className:"text-[10px] text-slate-500 font-mono italic shrink-0 ml-auto",children:"Только Просмотр"})]}),e.jsx("div",{className:"flex-1 bg-black/60 overflow-hidden relative shadow-[0_0_50px_rgba(0,0,0,0.5)] flex items-center justify-center backdrop-blur-sm group select-none p-4",children:n?e.jsxs("div",{className:`relative inline-flex justify-center items-center max-w-full ${t&&Q?"cursor-move":t?"cursor-crosshair":"cursor-default"}`,ref:te,onClick:ce,style:{touchAction:"none"},children:[e.jsx("img",{src:n.image_url,alt:n.name,className:"block max-w-full h-auto",style:{maxHeight:"calc(100vh - 8rem)",width:"auto"}}),F.map(m=>e.jsxs("div",{className:`map-pin absolute transform -translate-x-1/2 -translate-y-1/2 group/pin z-30 transition-transform ${Q&&R===m.id?"scale-125 opacity-80":"scale-100"} p-2 cursor-pointer`,style:{left:`${m.x}%`,top:`${m.y}%`},onClick:S=>oe(S,m),onMouseDown:S=>l(S,m.id),onTouchStart:S=>l(S,m.id),children:[e.jsx($e,{style:{color:m.color||"#8b5cf6",filter:`drop-shadow(0 0 ${8*(m.brightness||1)}px ${m.color||"#8b5cf6"}) brightness(${m.brightness||1})`},className:`w-4 h-4 md:w-6 md:h-6 lg:w-8 lg:h-8 ${!Q&&"hover:scale-125"} transition-transform duration-200`}),e.jsxs("div",{className:"absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-black/90 px-2 py-1 rounded-lg text-[10px] md:text-xs whitespace-nowrap opacity-0 group-hover/pin:opacity-100 pointer-events-none transition-all border border-white/10 shadow-xl -translate-y-2 group-hover/pin:translate-y-0 backdrop-blur-md z-40",style:{color:m.color||"#e2e8f0"},children:[m.label,m.locationId&&e.jsxs("span",{className:"block text-[8px] md:text-[9px] opacity-60 font-mono flex items-center gap-1 justify-center mt-0.5",children:[e.jsx(Fe,{size:8})," СМОТРЕТЬ"]})]})]},m.id))]}):e.jsx("div",{className:"text-slate-500 h-full flex items-center justify-center",children:c.length===0?"Нет доступных карт. Создайте.":"Выберите карту"})}),e.jsx(K,{isOpen:s,onClose:()=>i(!1),title:o?"Ред. Метку":"Поставить Метку",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-slate-900/50 p-4 rounded-lg border border-slate-800",children:[e.jsx("label",{className:"text-xs text-slate-400 uppercase tracking-widest font-bold mb-3 block",children:"Внешний вид"}),e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsx("div",{className:"flex gap-2 flex-wrap flex-1",children:ts.map(m=>e.jsx("button",{onClick:()=>P({...y,color:m}),className:`w-6 h-6 rounded-full border-2 transition-transform hover:scale-110 ${y.color===m?"border-white scale-110":"border-transparent"}`,style:{backgroundColor:m,boxShadow:`0 0 10px ${m}40`}},m))}),e.jsx("div",{className:"shrink-0 p-2 bg-black/50 rounded border border-white/5",children:e.jsx($e,{size:32,style:{color:y.color,filter:`drop-shadow(0 0 ${8*y.brightness}px ${y.color}) brightness(${y.brightness})`}})})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("label",{className:"flex justify-between text-[10px] text-slate-500 mb-1",children:[e.jsx("span",{children:"Тусклый"}),e.jsx("span",{children:"Интенсивность"}),e.jsx("span",{children:"Яркий"})]}),e.jsx("input",{type:"range",min:"0.5",max:"2.0",step:"0.1",value:y.brightness,onChange:m=>P({...y,brightness:parseFloat(m.target.value)}),className:"w-full accent-violet-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer"})]})]}),e.jsxs("div",{className:"flex border-b border-slate-800",children:[e.jsxs("button",{onClick:()=>E("existing"),className:`flex-1 py-2 text-sm font-fantasy tracking-wide border-b-2 transition-colors ${z==="existing"?"border-violet-500 text-violet-200":"border-transparent text-slate-500"}`,children:[e.jsx(ct,{size:14,className:"inline mr-2"})," Привязать Локацию"]}),e.jsxs("button",{onClick:()=>E("new"),className:`flex-1 py-2 text-sm font-fantasy tracking-wide border-b-2 transition-colors ${z==="new"?"border-violet-500 text-violet-200":"border-transparent text-slate-500"}`,children:[e.jsx(ne,{size:14,className:"inline mr-2"})," Начертать Руну"]})]}),e.jsx("div",{className:"min-h-[200px]",children:z==="existing"?e.jsx("div",{className:"border border-slate-800 rounded-lg bg-slate-900/30 max-h-60 overflow-y-auto custom-scrollbar p-2",children:_.map(m=>e.jsx(Me,{node:m,level:0,onSelect:S=>M(S),selectedId:ee},m.id))}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{className:"w-full bg-slate-950 border border-slate-700 p-2 rounded text-white focus:border-violet-500 outline-none",placeholder:"Метка",value:N.name,onChange:m=>b({...N,name:m.target.value})}),e.jsx("textarea",{className:"w-full bg-slate-950 border border-slate-700 p-2 rounded text-white focus:border-violet-500 outline-none resize-none",rows:3,placeholder:"Краткое описание...",value:N.description,onChange:m=>b({...N,description:m.target.value})})]})}),e.jsxs("div",{className:"flex gap-3",children:[o&&e.jsx("button",{type:"button",onClick:at,className:"px-4 py-3 bg-red-900/40 hover:bg-red-800 text-red-200 border border-red-800/50 rounded-lg transition-colors",children:e.jsx(_e,{size:20})}),e.jsx("button",{onClick:I,className:"flex-1 py-3 bg-violet-700 hover:bg-violet-600 text-white rounded-lg font-fantasy tracking-widest uppercase shadow-[0_0_15px_rgba(139,92,246,0.3)] transition-all",children:o?"Обновить":"Подтвердить"})]})]})}),e.jsx(K,{isOpen:$,onClose:()=>O(!1),title:B.id?"Обновить Карту":"Новая Карта",children:e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs text-slate-400",children:"Название Карты"}),e.jsx(Be,{required:!0,autoFocus:!0,placeholder:"напр. Северные Пустоши",value:B.name,onChange:m=>A({...B,name:m.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs text-slate-400",children:"URL Изображения"}),e.jsx(Be,{required:!0,placeholder:"https://...",value:B.image_url,onChange:m=>A({...B,image_url:m.target.value})})]}),e.jsx("button",{type:"submit",className:"w-full mt-4 group relative px-6 py-3 bg-slate-900 border-2 border-emerald-500/50 shadow-[0_0_15px_rgba(16,185,129,0.2)] text-emerald-100 font-fantasy tracking-[0.2em] uppercase hover:bg-emerald-900/40 hover:border-emerald-400 hover:shadow-[0_0_25px_rgba(16,185,129,0.6)] transition-all duration-300 overflow-hidden",children:e.jsx("span",{className:"relative z-10",children:B.id?"Сохранить":"Развернуть Карту"})})]})}),e.jsx(ze,{isOpen:U.isOpen,title:U.title,message:U.message,onClose:()=>Y(m=>({...m,isOpen:!1})),onConfirm:U.onConfirm,isDangerous:!0})]})},Ae=["Торговец ушел за товаром...","Караван ограблен бандитами...","Приходите вчера...","Только пыль на полках...","Учет переучет...","Товар задержан на таможне...","Продавец спит, не будить...","Все продано...","Рынок закрыт на карантин...","Дракон съел все запасы..."],as=({isAdmin:t})=>{const a=r.useMemo(()=>Ae[Math.floor(Math.random()*Ae.length)],[]);return e.jsxs("div",{className:"h-full flex flex-col bg-[#050b14] overflow-hidden relative items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 opacity-10 pointer-events-none",style:{backgroundImage:"radial-gradient(#4c1d95 1px, transparent 1px)",backgroundSize:"20px 20px"}}),e.jsxs("div",{className:"flex flex-col items-center gap-6 p-8 border-2 border-dashed border-slate-700 rounded-xl bg-slate-900/50 backdrop-blur-sm max-w-md text-center",children:[e.jsx("div",{className:"p-4 bg-amber-900/20 rounded-full border border-amber-600/30 text-amber-500",children:e.jsx(It,{size:48})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-fantasy font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-yellow-600 tracking-widest uppercase mb-2",children:"Рынок"}),e.jsxs("p",{className:"text-slate-400 font-serif italic text-lg",children:['"',a,'"']})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 bg-slate-950 px-3 py-1 rounded border border-slate-800",children:[e.jsx(nt,{size:12}),e.jsx("span",{children:"Раздел находится в разработке"})]})]})]})},rs={wiki:"https://vadwslmqajbbmklrhnzu.supabase.co/storage/v1/object/public/Juul-D-Page/lore-states.jpg",maps:"https://vadwslmqajbbmklrhnzu.supabase.co/storage/v1/object/public/Juul-D-Page/lore-maps.jpg",locations:"https://vadwslmqajbbmklrhnzu.supabase.co/storage/v1/object/public/Juul-D-Page/lore-locations.jpg",quests:"https://vadwslmqajbbmklrhnzu.supabase.co/storage/v1/object/public/Juul-D-Page/lore-quests.jpg",library:"https://vadwslmqajbbmklrhnzu.supabase.co/storage/v1/object/public/Juul-D-Page/lore-library.jpg",market:"https://vadwslmqajbbmklrhnzu.supabase.co/storage/v1/object/public/Juul-D-Page/lore-library.jpg"},cs=({isAdmin:t=!1})=>{const[a,c]=r.useState(()=>localStorage.getItem("lore_last_tab")||"wiki"),[p,f]=r.useState(null),[x,w]=r.useState(!1);r.useEffect(()=>{localStorage.setItem("lore_last_tab",a)},[a]);const g=s=>{f(s),c("maps")},C=()=>{switch(a){case"library":return e.jsx(Qt,{isAdmin:t});case"quests":return e.jsx(Wt,{isAdmin:t});case"wiki":return e.jsx(Pe,{isAdmin:t});case"locations":return e.jsx(es,{isAdmin:t,onNavigateToMap:g});case"maps":return e.jsx(ss,{isAdmin:t,initialMapId:p});case"market":return e.jsx(as,{isAdmin:t});default:return e.jsx(Pe,{isAdmin:t})}},d=({tab:s,icon:i,label:o})=>e.jsxs("button",{onClick:()=>c(s),title:o,className:`flex flex-col items-center justify-center p-3 w-full transition-all duration-300 border-l-4 ${a===s?"bg-indigo-900/80 border-violet-500 text-violet-400 shadow-[inset_10px_0_20px_-10px_rgba(139,92,246,0.3)]":"border-transparent text-slate-500 hover:text-slate-300 hover:bg-slate-900/50"}`,children:[e.jsx(i,{size:24,className:"mb-1"}),e.jsx("span",{className:`text-[8px] uppercase tracking-widest font-semibold transition-opacity duration-300 ${x?"opacity-0 h-0 overflow-hidden":"opacity-100"}`,children:o})]}),n=a==="library"||a==="quests";return e.jsxs("div",{className:"relative w-full h-[calc(100dvh-3rem)] md:h-screen overflow-hidden bg-slate-950 text-slate-200 flex",children:[e.jsx("style",{children:`
        @keyframes breath {
          0%, 100% { opacity: 0.5; }
          50% { opacity: 0.9; }
        }
        .animate-breath {
          animation: breath 5s ease-in-out infinite;
        }
      `}),e.jsx("div",{className:"fixed inset-0 z-0 transition-opacity duration-700 ease-in-out pointer-events-none",style:{backgroundImage:`url(${rs[a]})`,backgroundSize:"cover",backgroundPosition:"center",filter:"brightness(0.2) blur(3px) sepia(0.2) hue-rotate(180deg)"}}),e.jsx("div",{className:`fixed inset-x-0 bottom-[-5%] h-[90%] bg-gradient-to-t from-black via-black/90 to-transparent pointer-events-none z-0 transition-opacity duration-1000 ${n?"opacity-100 animate-breath":"opacity-0"}`}),e.jsxs("nav",{className:`
            relative z-50 bg-slate-950/95 border-r border-indigo-900/30 flex flex-col items-center shadow-2xl backdrop-blur-md shrink-0 transition-[width,transform] duration-300 ease-in-out
            ${x?"w-0 -translate-x-full md:translate-x-0 md:w-0 md:border-r-0":"w-20 md:w-24 translate-x-0"}
        `,children:[e.jsxs("div",{className:"flex flex-col w-full space-y-1 md:space-y-2 overflow-y-auto no-scrollbar flex-1 pt-4",children:[e.jsx(d,{tab:"wiki",icon:le,label:"Вики"}),e.jsx(d,{tab:"maps",icon:Se,label:"Карты"}),e.jsx(d,{tab:"locations",icon:Ce,label:"Места"}),e.jsx(d,{tab:"quests",icon:Ot,label:"Квесты"}),e.jsx(d,{tab:"library",icon:Ne,label:"Библиотека"}),e.jsx(d,{tab:"market",icon:dt,label:"Рынок"})]}),e.jsxs("div",{className:"mt-auto flex flex-col items-center gap-4 w-full pb-8 pt-4 border-t border-white/5 bg-black/20",children:[e.jsx("div",{onClick:()=>w(!0),className:"p-2 border border-violet-500/20 rounded-full bg-slate-900 cursor-pointer hover:border-violet-500/50 transition-colors select-none group",title:"Свернуть меню",children:e.jsx("div",{className:`w-8 h-8 md:w-10 md:h-10 rounded-full bg-violet-600 shadow-[0_0_15px_rgba(139,92,246,0.6)] group-hover:shadow-[0_0_25px_rgba(139,92,246,0.8)] transition-all ${t?"ring-2 ring-emerald-400":"animate-pulse"}`})}),e.jsx("div",{className:"text-[10px] md:text-xs text-slate-600 font-fantasy opacity-50 flex flex-col items-center gap-1 whitespace-nowrap",children:t&&e.jsx("span",{className:"text-emerald-500 font-bold",children:"ADMIN"})})]})]}),e.jsx("button",{onClick:()=>w(!1),className:`
            absolute bottom-4 left-4 z-[60] p-2 rounded-full bg-slate-900/90 border border-violet-500/50 text-violet-400 shadow-[0_0_15px_rgba(139,92,246,0.5)] 
            transition-all duration-500 ease-out hover:scale-110 hover:border-violet-400 hover:text-white
            ${x?"translate-y-0 opacity-100":"translate-y-20 opacity-0 pointer-events-none"}
        `,children:e.jsx("div",{className:`w-6 h-6 rounded-full bg-violet-600 shadow-[0_0_10px_rgba(139,92,246,0.6)] ${t?"ring-1 ring-emerald-400":"animate-pulse"}`})}),e.jsx("main",{className:"flex-1 h-full relative z-10 overflow-hidden",children:e.jsx("div",{className:"w-full h-full relative",children:C()})})]})};export{cs as default};
